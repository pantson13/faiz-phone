<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>FAIZ Phone â€“ 15é”®æµ‹è¯•(çº¯HTML)</title>
<style>
  :root{--bg:#0b0f19;--bg-red:#7f1d1d;--fg:#fff;--panel:#0f172a;--border:#334155;--muted:#94a3b8}
  *{box-sizing:border-box}
  html{-webkit-text-size-adjust:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
  .wrap{max-width:480px;margin:0 auto;padding:16px;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .card{width:100%}
  h1{margin:0 0 8px;font-size:18px;text-align:center}
  .display{display:flex;align-items:center;justify-content:space-between;background:#0f172acc;border:1px solid var(--border);border-radius:12px;height:48px;padding:0 12px;margin-bottom:8px}
  .digits{font-weight:700;letter-spacing:.3em}
  .hint{font-size:12px;color:var(--muted)}
  .panel{background:#0f172a99;border:1px solid var(--border);border-radius:16px;padding:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
  .keys{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button.key{width:100%;height:56px;border-radius:14px;border:1px solid var(--border);background:#0f172acc;color:#fff;font-weight:700;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0)}
  button.key:active{transform:scale(.98)}
  .status{font-size:12px;color:var(--muted);margin:6px 0 10px}
  .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f172a;color:#fff;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
  .modal>.box{width:min(92vw,720px);max-height:86vh;overflow:auto;background:#0b0f1a;border:1px solid var(--border);border-radius:16px;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .muted{font-size:12px;color:var(--muted)}
  .drop{border:1px dashed var(--border);border-radius:12px;padding:16px;text-align:center;color:var(--muted);margin-bottom:12px;cursor:pointer}
  .pair{border:1px solid var(--border);border-radius:12px;padding:10px}
  .tag{font-size:12px;color:var(--muted)}
  .ok{color:#22c55e}
  .warn{color:#fbbf24}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="card">
    <h1>FAIZ Phone â€“ 15 é”®æµ‹è¯•ï¼ˆçº¯HTMLï¼‰</h1>
    <div class="display"><div class="digits" id="digits">â€”â€”â€”</div><div class="hint" id="hint">ç‚¹ä»»æ„é”®è§£é”éŸ³é¢‘</div></div>

    <div class="panel" id="panel">
      <!-- ç¬¬ä¸€è¡Œï¼šENTER ç‹¬ç«‹ä¸€è¡Œï¼ˆå±…å·¦ï¼‰ï¼Œå…¶å®ƒä¸¤æ ¼ç•™ç©ºä¿è¯å¯¹é½ -->
      <div class="grid3">
        <button class="key" id="btnEnter">ENTER</button>
        <div></div>
        <div></div>
      </div>

      <!-- ç¬¬äºŒè¡Œï¼šé“ƒå£° / å¾…å®š / åœæ­¢ï¼Œå°ºå¯¸ä¸æ•°å­—é”®ä¸€è‡´ -->
      <div class="grid3">
        <button class="key" id="btnRing">â˜ï¸ é“ƒå£°</button>
        <button class="key" id="btnUnset">å¾…å®š</button>
        <button class="key" id="btnStop">â›”ï¸ åœæ­¢</button>
      </div>

      <div class="status" id="status">å¾…æœº</div>
      <div class="keys" id="keys"></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnBrowser">ğŸ“‚ æµè§ˆ/ç®¡ç†éŸ³æ•ˆ</button>
      <button class="btn" id="btnExport">å¯¼å‡º JSON</button>
      <button class="btn" id="btnClear">æ¸…ç©º</button>
    </div>
  </div>
</div>

<!-- éŸ³æ•ˆç®¡ç†å™¨ -->
<div class="modal" id="modal">
  <div class="box">
    <div class="row"><div>æµè§ˆå’Œç®¡ç†éŸ³æ•ˆ</div><div style="flex:1"></div><button class="btn" id="btnClose">å…³é—­</button></div>
    <div class="row">
      <label class="btn">æ‰¹é‡é€‰æ‹©æ–‡ä»¶<input type="file" id="fileMulti" style="display:none" multiple accept="audio/*" /></label>
      <div class="muted">æŒ‰æ–‡ä»¶åè‡ªåŠ¨åŒ¹é…ï¼šopen phone / ring / enter / key1 / key5_2 / key5_3 / stand by / complete / 103 / 106 / 3821</div>
    </div>
    <div class="drop" id="drop">ç‚¹å‡»æˆ–æ‹–å…¥éŸ³é¢‘æ–‡ä»¶åˆ°è¿™é‡Œï¼Œè‡ªåŠ¨åŒ¹é…å¹¶ä¿å­˜ï¼ˆä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼‰</div>
    <div id="pairs" class="grid3" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"></div>
  </div>
</div>

<script>
(function(){
  const digitsEl = document.getElementById('digits');
  const hintEl   = document.getElementById('hint');
  const statusEl = document.getElementById('status');
  const wrapEl   = document.getElementById('wrap');
  const keysEl   = document.getElementById('keys');

  // â€”â€”â€” æŒä¹…åŒ–é…ç½®ï¼ˆBase64 DataURLï¼‰ â€”â€”â€”
  const cfg = (()=>{ try{ return JSON.parse(localStorage.getItem('faiz_cfg_v1')||'{}'); }catch{ return {}; } })();
  const saveCfg = ()=>{ try{ localStorage.setItem('faiz_cfg_v1', JSON.stringify(cfg)); }catch(e){} };

  // â€”â€”â€” iOS éŸ³é¢‘è§£é”/æ’­æ”¾å·¥å…· â€”â€”â€”
  let started=false, ac=null, ringNode=null, standNode=null;
  function ensureAC(){ if(ac) return ac; const C=window.AudioContext||window.webkitAudioContext; if(!C) return null; ac=new C(); return ac; }
  function resumeAudio(){ const ctx=ensureAC(); if(!ctx) return; if(ctx.state==='suspended') ctx.resume().catch(()=>{}); }
  function unlockOnce(){ if(started) return; started=true; resumeAudio(); hintEl.textContent='å·²è§£é”'; playKey('openPhone'); }

  function beep(o){ const ctx=ensureAC(); if(!ctx) return; const opt=o||{}; const osc=ctx.createOscillator(); const g=ctx.createGain();
    osc.type=opt.type||'square'; osc.frequency.value=opt.freq||520; g.gain.value=(opt.vol??0.24); osc.connect(g).connect(ctx.destination);
    osc.start(); setTimeout(()=>{ try{g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05);}catch{} try{osc.stop();}catch{} }, opt.ms||140);
  }

  // ç»Ÿä¸€æ’­æ”¾ï¼ˆä¼˜å…ˆæœ¬åœ°æ˜ å°„ï¼‰
  function playKey(name, loop=false){
    const map = { stay:'standBy', ringStart:'openPhone' };
    const key = map[name] || name;
    const url = cfg[key];
    if(!url){
      if(key==='enter')    return beep({freq:560,ms:160,type:'sawtooth',vol:0.26});
      if(key==='complete') return beep({freq:260,ms:360,type:'square',vol:0.30});
      if(key==='standBy')  return beep({freq:720,ms:260,type:'triangle',vol:0.28});
      return beep();
    }
    try{ const a=new Audio(url); a.loop=!!loop; a.play().catch(()=>{}); return a; }catch{ return; }
  }
  function safePause(a){ if(a&&a.pause) try{a.pause();}catch{} }

  // â€”â€”â€” è§„åˆ™çŠ¶æ€ â€”â€”â€”
  let fiveCount=0, buf=''; let armedStand=false; let transformed=false;
  function showDigits(s){ digitsEl.textContent=(s||'').padStart(3,'â€”').slice(-3); }
  function setStatus(t){ statusEl.textContent=t; }

  function push(k){
    unlockOnce(); resumeAudio();
    if(k==='5'){ fiveCount=(fiveCount%3)+1; if(fiveCount===1) playKey('key1'); else if(fiveCount===2) playKey('key5_2'); else playKey('key5_3'); }
    else{ fiveCount=0; playKey('key1'); }
    buf=(buf+k).slice(-4); showDigits(buf);
    if(buf.endsWith('103'))  { setStatus('ç‰¹æ®Šï¼š103');  playKey('combo103'); }
    if(buf.endsWith('106'))  { setStatus('ç‰¹æ®Šï¼š106');  playKey('combo106'); }
    if(buf.endsWith('3821')) { setStatus('ç‰¹æ®Šï¼š3821'); playKey('combo3821'); }
    if(buf.endsWith('555'))  { setStatus('å·²è¾“å…¥ 555'); }
  }

  function ringStart(){ unlockOnce(); resumeAudio(); safePause(ringNode); ringNode=null; ringNode=playKey('ring', true); setStatus('å“é“ƒä¸­'); }
  function ringStop(){ safePause(ringNode); ringNode=null; setStatus('é“ƒå£°åœæ­¢'); }
  function onUnset(){ playKey('key1'); transformed=false; wrapEl.style.background='var(--bg)'; setStatus('è§£é™¤å˜èº«'); }

  // ENTERï¼š555â†’enterâ†’stand byï¼ˆä¸å¾ªç¯ï¼‰â†’å†æ¬¡ enterâ†’complete
  function onEnter(){
    unlockOnce(); resumeAudio();

    if(armedStand){
      safePause(standNode); standNode=null;
      const a=playKey('complete');
      const finish=()=>{ transformed=true; wrapEl.style.background='var(--bg-red)'; buf=''; showDigits(''); setStatus('å®Œæˆ'); };
      if(a) a.onended=finish; else setTimeout(finish,380);
      armedStand=false; return;
    }

    playKey('enter');

    if(buf.endsWith('555')){
      safePause(standNode); standNode=null;
      standNode=playKey('standBy', false); // ä¸å¾ªç¯
      if(standNode) standNode.onended=()=>{ standNode=null; };
      armedStand=true; setStatus('stand by');
    }else{
      setStatus('ENTER');
    }
  }

  // â€”â€”â€” æ¸²æŸ“é”®ç›˜ä¸äº‹ä»¶ â€”â€”â€”
  const grid=['1','2','3','4','5','6','7','8','9','*','0','#'];
  grid.forEach(k=>{ const b=document.createElement('button'); b.className='key'; b.textContent=k; b.onclick=()=>push(k); keysEl.appendChild(b); });
  document.getElementById('btnEnter').onclick = onEnter;
  document.getElementById('btnRing').onclick  = ringStart;
  document.getElementById('btnStop').onclick  = ringStop;
  document.getElementById('btnUnset').onclick = onUnset;

  // â€”â€”â€” éŸ³æ•ˆç®¡ç†ï¼ˆåç§°ä½¿ç”¨ä½ çš„å‘½åï¼‰ â€”â€”â€”
  const keyList=[
    ['openPhone','å¼€æœº (open phone)'],
    ['ring','é“ƒå£° (ring)'],
    ['enter','ENTER'],
    ['key1','æ™®é€šæŒ‰é”®'],
    ['key5_2','5(ç¬¬äºŒæ¬¡)'],
    ['key5_3','5(ç¬¬ä¸‰æ¬¡)'],
    ['standBy','stand by'],
    ['complete','complete'],
    ['combo103','103'],['combo106','106'],['combo3821','3821']
  ];
  const nameMap={
    'open phone':'openPhone','open_phone':'openPhone','openphone':'openPhone',
    'ring':'ring',
    'enter':'enter',
    'key1':'key1',
    'key5_2':'key5_2','key5-2':'key5_2','5_2':'key5_2',
    'key5_3':'key5_3','key5-3':'key5_3','5_3':'key5_3',
    'stand by':'standBy','stand_by':'standBy','standby':'standBy','stay':'standBy',
    'complete':'complete',
    '103':'combo103','combo103':'combo103',
    '106':'combo106','combo106':'combo106',
    '3821':'combo3821','combo3821':'combo3821'
  };
  const pairsEl=document.getElementById('pairs');
  function baseNoExt(n){ const i=n.lastIndexOf('.'); return (i>=0?n.slice(0,i):n).toLowerCase().trim(); }
  function refreshPairs(){
    pairsEl.innerHTML='';
    keyList.forEach(([key,label])=>{
      const d=document.createElement('div'); d.className='pair';
      d.innerHTML=`<div style="font-weight:600">${label} <span class="tag">(${key})</span></div>
        <div class="tag">${cfg[key]?'<span class="ok">âœ… å·²é…ç½®</span>':'<span class="warn">âš ï¸ æœªé…ç½®</span>'}</div>
        <div class="row">
          <label class="btn">é€‰æ‹©æ–‡ä»¶<input type="file" style="display:none" accept="audio/*" /></label>
          <button class="btn" data-act="preview">è¯•å¬</button>
          <button class="btn" data-act="clear">æ¸…é™¤</button>
          ${cfg[key]?`<audio controls src="${cfg[key]}" preload="none" style="width:100%;margin-top:6px"></audio>`:''}
        </div>`;
      const input=d.querySelector('input[type=file]');
      input.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ cfg[key]=r.result; saveCfg(); refreshPairs(); }; r.readAsDataURL(f); };
      d.querySelector('[data-act=preview]').onclick=()=>{ const u=cfg[key]; if(!u){ setStatus('æœªé…ç½®ï¼š'+key); beep(); return; } try{ new Audio(u).play().catch(()=>{});}catch{} };
      d.querySelector('[data-act=clear]').onclick=()=>{ delete cfg[key]; saveCfg(); refreshPairs(); };
      pairsEl.appendChild(d);
    });
  }
  refreshPairs();

  // æ‰¹é‡å¯¼å…¥
  const drop=document.getElementById('drop'), multi=document.getElementById('fileMulti');
  function autoMapList(files){
    let matched=0;
    [...files].forEach(f=>{
      const r=new FileReader();
      r.onload=()=>{ const key=nameMap[ baseNoExt(f.name) ]; if(key){ cfg[key]=r.result; matched++; saveCfg(); refreshPairs(); } };
      r.readAsDataURL(f);
    });
    setStatus('å·²é€‰æ‹© '+files.length+' ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨åŒ¹é… '+matched+' ä¸ª');
  }
  drop.addEventListener('click',()=>multi.click());
  drop.ondragover=(e)=>{ e.preventDefault(); };
  drop.ondrop=(e)=>{ e.preventDefault(); if(e.dataTransfer?.files) autoMapList(e.dataTransfer.files); };
  multi.onchange=(e)=>{ const fs=e.target.files; if(fs&&fs.length) autoMapList(fs); e.target.value=''; };

  // ç¬¬ä¸€æ¬¡ç”¨æˆ·æ‰‹åŠ¿ï¼šè§£é”éŸ³é¢‘å¹¶æ’­æ”¾ open phone
  ['pointerdown','touchend','click'].forEach(evt=>{
    document.addEventListener(evt, ()=>unlockOnce(), { once:true, passive:true });
  });

  // é¢å¤–æŠ‘åˆ¶ iOS æ‰‹åŠ¿æ”¾å¤§ï¼ˆåŒæŒ‡/åŒå‡»ï¼‰
  document.addEventListener('gesturestart', e=>{ e.preventDefault(); return false; });
})();
</script>
</body>
</html>
