<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>FAIZ Phone</title>
<style>
  :root{
    /* 皮肤图路径，按你的仓库实际文件改 */
    --ui-src: 'assets/ui.jpg';

    /* —— 键区相对整张图的“内边距”，百分比，可微调 —— */
    --frame-top: 47.5%;
    --frame-bottom: 6.5%;
    --frame-left: 16%;
    --frame-right: 16%;

    --bg:#0b0f19; --bg-red:#7f1d1d; --fg:#fff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0}
  body{
    background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-text-size-adjust:100%;
    touch-action:manipulation; user-select:none; -webkit-user-select:none;
  }

  /* 页面允许滚动：容器非 fixed，用 margin 居中 */
  .phone{
    position:relative;
    width:min(94vw,520px);
    margin:32px auto 80px;   /* 页面可上下滚动 */
  }

  /* 皮肤图片 */
  .bg{ width:100%; height:auto; display:block; }

  /* 覆盖在图上的透明按钮层（跟随图片缩放 & 滚动）*/
  .frame{
    position:absolute; z-index:1;
    left:var(--frame-left); right:var(--frame-right);
    top:var(--frame-top);   bottom:var(--frame-bottom);
    display:grid; grid-template-columns:repeat(3,1fr);
    grid-auto-rows:1fr; gap:0.9vh;
  }

  .hit{
    background:transparent; border:none; outline:none;
    touch-action:manipulation; -webkit-user-select:none; user-select:none;
  }
  .hit:active{ transform:scale(.98); }

  /* 第一行：ENTER 独占三列 */
  .enter{ grid-column:1 / 4; }
</style>
</head>
<body>

  <div class="phone" id="phone">
    <!-- 如果图片不是 assets/ui.jpg，请改下面 src -->
    <img id="ui" class="bg" src="assets/ui.jpg"
         alt="图片未找到：请检查 assets/ui.jpg 路径与大小写" />

    <!-- 透明点击层（与图片同容器，随滚动一起移动） -->
    <div class="frame" id="frame">
      <!-- 第1行：ENTER -->
      <button class="hit enter" aria-label="ENTER" id="btnEnter"></button>

      <!-- 第2行：铃声 / クリア / 停止 -->
      <button class="hit ring"  aria-label="铃声" id="btnRing"></button>
      <button class="hit clear" aria-label="クリア" id="btnClear"></button>
      <button class="hit stop"  aria-label="停止" id="btnStop"></button>

      <!-- 第3-6行：数字键（1~9、*0#） -->
      <button class="hit key" aria-label="1" data-k="1"></button>
      <button class="hit key" aria-label="2" data-k="2"></button>
      <button class="hit key" aria-label="3" data-k="3"></button>

      <button class="hit key" aria-label="4" data-k="4"></button>
      <button class="hit key" aria-label="5" data-k="5"></button>
      <button class="hit key" aria-label="6" data-k="6"></button>

      <button class="hit key" aria-label="7" data-k="7"></button>
      <button class="hit key" aria-label="8" data-k="8"></button>
      <button class="hit key" aria-label="9" data-k="9"></button>

      <button class="hit key" aria-label="*" data-k="*"></button>
      <button class="hit key" aria-label="0" data-k="0"></button>
      <button class="hit key" aria-label="#" data-k="#"></button>
    </div>
  </div>

<script>
(() => {
  /* ========== 音效文件（与你仓库 assets 下文件名一致）========== */
  const ASSET = {
    openPhone: 'assets/open phone.m4a',
    ring:      'assets/ring.m4a',
    enter:     'assets/enter.m4a',
    key1:      'assets/key1.m4a',
    key5_2:    'assets/key5_2.m4a',
    key5_3:    'assets/key5_3.m4a',
    standBy:   'assets/stand by.m4a',
    complete:  'assets/complete.m4a',
    error:     'assets/error.m4a',
    ready:     'assets/ready.m4a',
    exceed:    'assets/exceed charge.m4a',
    release:   'assets/release.m4a',
    combo3821: 'assets/3821.m4a'
  };

  /* ========== 低延迟 WebAudio 播放 ========== */
  let ac=null, masterGain=null; const buffers=new Map();
  function ensureAC(){
    if(ac) return ac;
    const C=window.AudioContext||window.webkitAudioContext; if(!C) return null;
    ac=new C({latencyHint:'interactive'}); masterGain=ac.createGain();
    masterGain.gain.value=1.0; masterGain.connect(ac.destination); return ac;
  }
  async function loadBuffer(key){
    if(buffers.has(key)) return buffers.get(key);
    const url=ASSET[key]; if(!url) return null;
    const res=await fetch(url,{cache:'no-store'}); if(!res.ok) return null;
    const arr=await res.arrayBuffer(); const ctx=ensureAC();
    const buf=await ctx.decodeAudioData(arr); buffers.set(key,buf); return buf;
  }
  function playNow(key,{loop=false}={}){
    const ctx=ensureAC(); if(!ctx) return null;
    const buf=buffers.get(key); if(!buf) return null;
    const src=ctx.createBufferSource(); src.buffer=buf; src.loop=!!loop;
    src.connect(masterGain); src.start(0); return src;
  }
  function safeStop(n){ if(n && n.stop){ try{n.stop(0);}catch{} } }

  /* ========== 解锁 + 预加载 + 开机音 ========== */
  let unlocked=false;
  async function unlockAndPreload(){
    if(unlocked) return;
    const ctx=ensureAC(); try{ if(ctx.state==='suspended') await ctx.resume(); }catch{}
    unlocked=true;
    await Promise.all(Object.keys(ASSET).map(k=>loadBuffer(k).catch(()=>null)));
    playNow('openPhone'); // 开机音
  }
  ['pointerdown','touchend','click'].forEach(ev=>{
    document.addEventListener(ev, ()=>unlockAndPreload(), {once:true, passive:true});
  });

  /* ========== 规则状态 ========== */
  const SPECIAL_STAGE=['555','106','103'];
  let buf='', transformed=false, armedStand=false, transformedReady=false;
  let ringNode=null, standNode=null;

  function stageFor(b){ for(const c of SPECIAL_STAGE){ if(c.startsWith(b)) return b.length; } return 0; }
  function maybeInterruptRing(){ if(ringNode){ safeStop(ringNode); ringNode=null; } }

  async function pushDigit(k){
    await unlockAndPreload();
    maybeInterruptRing();

    const newBuf=(buf+k).slice(-3);
    const stg=stageFor(newBuf);
    if     (stg===1) playNow('key1');
    else if(stg===2) playNow('key5_2');
    else if(stg===3) playNow('key5_3');
    else             playNow('key1');

    buf=newBuf;
    if(buf==='3821') playNow('combo3821');
  }

  async function onEnter(){
    await unlockAndPreload();
    maybeInterruptRing();

    if(transformed){
      if(!transformedReady){ playNow('ready'); transformedReady=true; }
      else { playNow('exceed'); transformedReady=false; }
      return;
    }
    if(armedStand){
      safeStop(standNode); standNode=null;
      const src=playNow('complete');
      const finish=()=>{ transformed=true; transformedReady=false; armedStand=false; document.body.style.background='var(--bg-red)'; buf=''; };
      if(src) src.onended=finish; else setTimeout(finish,380);
      return;
    }
    playNow('enter');

    if(buf==='555'){
      safeStop(standNode); standNode=null;
      standNode=playNow('standBy'); if(standNode) standNode.onended=()=>{ standNode=null; };
      armedStand=true; return;
    }

    if(buf.length===3 && buf!=='106' && buf!=='103' && buf!=='3821'){
      playNow('error'); buf=''; armedStand=false; transformedReady=false; return;
    }
  }

  async function ringStart(){ await unlockAndPreload(); safeStop(ringNode); ringNode=playNow('ring',{loop:true}); }
  async function ringStop(){ await unlockAndPreload(); playNow('key1'); safeStop(ringNode); ringNode=null; } // 停止有按键声

  async function onClear(){
    await unlockAndPreload();
    maybeInterruptRing();
    if(!transformed){ playNow('key1'); return; }
    playNow('key1');
    const src=playNow('release');
    const finish=()=>{ transformed=false; armedStand=false; transformedReady=false; document.body.style.background='var(--bg)'; buf=''; };
    if(src) src.onended=finish; else finish();
  }

  /* 事件绑定 */
  document.querySelectorAll('.key').forEach(b=>{
    b.addEventListener('click', ()=>pushDigit(b.dataset.k));
  });
  document.getElementById('btnEnter').addEventListener('click', onEnter);
  document.getElementById('btnRing').addEventListener('click', ringStart);
  document.getElementById('btnStop').addEventListener('click', ringStop);
  document.getElementById('btnClear').addEventListener('click', onClear);
})();
</script>
</body>
</html>
