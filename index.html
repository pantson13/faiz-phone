<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FAIZ Phone</title>

<!-- PWA 清单 & 主题色 -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0f19" />

<style>
  :root{--bg:#0b0f19;--bg-red:#7f1d1d;--fg:#fff;--panel:#0f172a;--border:#334155;--muted:#94a3b8}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
  .wrap{max-width:520px;margin:0 auto;padding:16px;min-height:100vh;display:flex;flex-direction:column;gap:14px}
  h1{margin:0 0 6px;font-size:18px;text-align:center}
  .display{display:flex;align-items:center;justify-content:space-between;background:#0f172acc;border:1px solid var(--border);border-radius:12px;height:48px;padding:0 12px;margin-bottom:8px}
  .digits{font-weight:700;letter-spacing:.3em}
  .hint{font-size:12px;color:var(--muted)}
  .panel{background:#0f172a99;border:1px solid var(--border);border-radius:16px;padding:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
  .keys{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button.key{width:100%;height:56px;border-radius:14px;border:1px solid var(--border);background:#0f172acc;color:#fff;font-weight:700}
  button.key:active{transform:scale(.98)}
  .status{font-size:12px;color:var(--muted);margin:6px 0 10px}
  .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f172a;color:#fff}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <h1>FAIZ Phone – 15 键（预置音效，无需每次上传）</h1>
  <div class="display"><div class="digits" id="digits">———</div><div class="hint" id="hint">点任意键解锁音频（将自动播放 open phone）</div></div>

  <div class="panel">
    <!-- 上排：ENTER 独立一行 -->
    <div class="grid3">
      <button class="key" id="btnEnter">ENTER</button>
      <div></div><div></div>
      <!-- 第二排：铃声 / 待定 / 停止 -->
      <button class="key" id="btnRing">☎︎ 铃声</button>
      <button class="key" id="btnUnset">待定</button>
      <button class="key" id="btnStop">⛔︎ 停止</button>
    </div>

    <div class="status" id="status">待机</div>

    <!-- 3×4 数字键 -->
    <div class="keys" id="keys"></div>
  </div>

  <div class="actions">
    <button class="btn" id="btnClear">清空输入</button>
  </div>
</div>

<script>
(function(){
  // --- DOM
  const digitsEl = document.getElementById('digits');
  const hintEl = document.getElementById('hint');
  const statusEl = document.getElementById('status');
  const wrapEl = document.getElementById('wrap');
  const keysEl = document.getElementById('keys');

  // --- 本机配置（可被“浏览/管理”界面写入；此处只用作将来扩展）
  const cfg = (()=>{ try{ return JSON.parse(localStorage.getItem('faiz_cfg_v1')||'{}'); }catch{ return {}; } })();
  function saveCfg(){ try{ localStorage.setItem('faiz_cfg_v1', JSON.stringify(cfg)); }catch(e){} }

  // --- 预置的默认音频（仓库自带的 assets/*.m4a）
  const defaults = {
    openPhone:  'assets/open-phone.m4a',  // 开机（open phone）
    enter:      'assets/enter.m4a',
    standBy:    'assets/stand-by.m4a',    // 原 stay -> stand by
    complete:   'assets/complete.m4a',
    key1:       'assets/key1.m4a',
    key5_2:     'assets/key5_2.m4a',
    key5_3:     'assets/key5_3.m4a',
    combo103:   'assets/combo103.m4a',
    combo106:   'assets/combo106.m4a',
    combo3821:  'assets/combo3821.m4a',
    ringStart:  'assets/ring.m4a'         // 铃声（可选）
  };

  // --- 状态机
  let started=false; let fiveCount=0; let buf=''; let armedStand=false; let transformed=false;
  let ringNode=null; let standNode=null;

  // --- 声音
  function ensureAC(){ const C=window.AudioContext||window.webkitAudioContext; return C? new C():null; }
  function beep(o){ const opt=o||{}; try{ const C=window.AudioContext||window.webkitAudioContext; const ac=new C(); const osc=ac.createOscillator(); const g=ac.createGain(); osc.type=opt.type||'square'; osc.frequency.value=opt.freq||520; g.gain.value=(opt.vol==null?0.22:opt.vol); osc.connect(g).connect(ac.destination); osc.start(); setTimeout(()=>{ try{osc.stop();}catch{} }, opt.ms||140);}catch{} }

  function playKey(name, loop){
    // 兼容：旧名 stay -> 统一 standBy
    const key = (name==='stay') ? 'standBy' : name;
    const url = cfg[key] || defaults[key];
    if(!url){
      if(key==='enter'){ return beep({freq:560,ms:160,type:'sawtooth',vol:0.26}); }
      if(key==='complete'){ return beep({freq:260,ms:360,type:'square',vol:0.30}); }
      if(key==='standBy'){ return beep({freq:720,ms:260,type:'triangle',vol:0.28}); }
      return beep({freq:520,ms:120,type:'square',vol:0.24});
    }
    try{ const a=new Audio(url); a.loop=!!loop; a.play().catch(()=>{}); return a; }catch{ return; }
  }
  function safePause(n){ if(n && typeof n.pause==='function'){ try{ n.pause(); }catch{} } }

  function showDigits(s){ const t=(s||'').padStart(3,'—').slice(-3); digitsEl.textContent=t; }
  function setStatus(t){ statusEl.textContent=t; }

  function unlock(){
    if(!started){
      started=true;
      ensureAC();
      hintEl.textContent='已解锁';
      // 自动播放开机音
      playKey('openPhone');
      setStatus('open phone');
    }
  }

  // --- 规则：数字键与特殊
  function push(k){
    unlock();
    if(k==='*'||k==='#'){ playKey('key1'); return; }

    if(k==='5'){
      fiveCount=(fiveCount%3)+1;
      if(fiveCount===1) playKey('key1');
      else if(fiveCount===2) playKey('key5_2');
      else playKey('key5_3');
    }else{
      fiveCount=0; playKey('key1');
    }

    buf=(buf+k).slice(-4);
    showDigits(buf);

    if(buf.endsWith('103')){ setStatus('特殊：103'); playKey('combo103'); }
    if(buf.endsWith('106')){ setStatus('特殊：106'); playKey('combo106'); }
    if(buf.endsWith('3821')){ setStatus('特殊：3821'); playKey('combo3821'); }
    if(buf.endsWith('555')){ setStatus('已输入 555'); }
  }

  function onEnter(){
    unlock();
    if(armedStand){
      // 第二次 ENTER：只播 complete（不再播 enter），清空并变红
      safePause(standNode); standNode=null;
      const a=playKey('complete');
      const after=()=>{ transformed=true; wrapEl.style.background='var(--bg-red)'; buf=''; showDigits(''); setStatus('完成'); };
      if(a){ try{ a.onended=after; }catch{ setTimeout(after,380); } } else { setTimeout(after,380); }
      armedStand=false; return;
    }
    // 第一次 ENTER：先播 enter
    playKey('enter');
    if(buf.endsWith('555')){
      safePause(standNode); standNode=null;
      const n=playKey('standBy', false); // stand by 不循环
      if(n){ try{ n.onended=()=>{ standNode=null; }; }catch{} standNode=n; }
      armedStand=true; setStatus('stand by');
    }else{
      setStatus('ENTER');
    }
  }

  function ringStart(){ unlock(); safePause(ringNode); ringNode=null; const url=cfg['ringStart']||defaults['ringStart']; if(url){ const a=new Audio(url); a.loop=true; a.play().catch(()=>{}); ringNode=a; }else{ const id=setInterval(()=>{ beep({freq:660,ms:150,vol:0.18}); setTimeout(()=>beep({freq:550,ms:150,vol:0.18}),170); },320); ringNode={ pause:()=>clearInterval(id) }; } setStatus('响铃中'); }
  function ringStop(){ safePause(ringNode); ringNode=null; setStatus('铃声停止'); }
  function onUnset(){ playKey('key1'); transformed=false; wrapEl.style.background='var(--bg)'; setStatus('解除变身'); }

  // --- 构建键盘
  ['1','2','3','4','5','6','7','8','9','*','0','#'].forEach(k=>{ const b=document.createElement('button'); b.className='key'; b.textContent=k; b.onclick=()=>push(k); keysEl.appendChild(b); });

  // --- 绑定按钮
  document.getElementById('btnEnter').onclick=onEnter;
  document.getElementById('btnRing').onclick=ringStart;
  document.getElementById('btnStop').onclick=ringStop;
  document.getElementById('btnUnset').onclick=onUnset;
  document.getElementById('btnClear').onclick=()=>{ buf=''; showDigits(''); armedStand=false; setStatus('已清空'); };
})();
</script>

<!-- 注册 Service Worker（在 HTTPS 或 localhost 生效） -->
<script>
  'serviceWorker' in navigator && navigator.serviceWorker.register('./sw.js', { scope: './' });
</script>
</body>
</html>
