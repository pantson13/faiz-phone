<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FAIZ 一键预览（可指定音效｜enter独立一行丨黑底白字）</title>
  <!-- PWA: manifest & theme color -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0f19">
  <style>
    :root{
      --bg:#0b0f19;--fg:#fff;--accent:#ff3b30;--muted:#96a0b5;--panel:#0f172a;
      --btn:#000;--btnText:#fff;--btnBorder:#374151;--btnHover:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"SF Pro Text",Segoe UI,Roboto,Arial}
    .wrap{max-width:560px;margin:0 auto;padding:16px;min-height:100vh;display:flex;flex-direction:column;gap:16px}
    h1{font-size:18px;margin:0;text-align:center;color:#cbd5e1}
    .screen{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:12px 14px}
    .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .row.cols-1{grid-template-columns:1fr}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    .btn{background:var(--btn);color:var(--btnText);border:1px solid var(--btnBorder);border-radius:14px;padding:14px 12px;font-weight:700;text-align:center;user-select:none;transition:transform .06s ease, background .15s ease}
    .btn:active{transform:scale(.98);background:var(--btnHover)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kbd{background:#0a0f1a;border:1px solid #1f2937;color:#e5e7eb;border-radius:12px;padding:12px 10px;text-align:center;font-weight:700}
    .io{display:flex;gap:10px}
    .io input{flex:1;background:#000;color:#0ef;border:1px solid #1f2937;border-radius:10px;padding:10px 12px;font-size:16px;letter-spacing:2px}
    .hint{color:#8aa; font-size:12px}
    details{background:#0a1020;border:1px solid #1f2937;border-radius:12px;padding:10px}
    details summary{cursor:pointer;color:#bcd}
    .status{height:8px;border-radius:999px;background:linear-gradient(90deg,#1f2937,#334155)}
    .status.transform{background:linear-gradient(90deg,#6b0000,var(--accent))}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>FAIZ Phone · 一键测试（可自选音效 / 规则按你最新要求）</h1>

    <div class="screen">
      <div class="io">
        <input id="display" placeholder="输入显示区" readonly>
      </div>
      <div class="status" id="st"></div>
    </div>

    <!-- Enter 独立一行，和铃声按钮同宽对齐（黑底白字） -->
    <div class="row cols-1">
      <button class="btn" id="btn-enter">ENTER</button>
    </div>

    <!-- 铃声 / 待定 / 停止铃声 在同一行；ENTER 上一行已对齐 -->
    <div class="row cols-3">
      <button class="btn" id="btn-ring">铃声</button>
      <button class="btn" id="btn-pending">待定</button>
      <button class="btn" id="btn-stop">停止铃声</button>
    </div>

    <!-- 数字键盘 3x4 黑底白字 -->
    <div class="grid" id="keypad"></div>

    <!-- 手动绑定音效（你说要可以“指定”） -->
    <details>
      <summary>音效绑定（可选） — 首次点击页面会自动播放 <b>open phone</b></summary>
      <div class="row cols-3" style="margin-top:10px">
        <label class="hint">open phone<input type="file" accept="audio/*" id="s-open"/></label>
        <label class="hint">enter<input type="file" accept="audio/*" id="s-enter"/></label>
        <label class="hint">stand by<input type="file" accept="audio/*" id="s-standby"/></label>
      </div>
      <div class="row cols-3">
        <label class="hint">complete<input type="file" accept="audio/*" id="s-complete"/></label>
        <label class="hint">普通按键<input type="file" accept="audio/*" id="s-key"/></label>
        <label class="hint">铃声<input type="file" accept="audio/*" id="s-ring"/></label>
      </div>
      <div class="row cols-3">
        <label class="hint">5（第二次）<input type="file" accept="audio/*" id="s-5-2"/></label>
        <label class="hint">5（第三次）<input type="file" accept="audio/*" id="s-5-3"/></label>
        <span class="hint" style="display:flex;align-items:center">其余：默认普通按键音</span>
      </div>
    </details>

    <div class="hint">提示：页面任意处点击一次用于解锁浏览器音频；随后自动播放 <b>open phone</b>。</div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const display = $('#display');
  const statusBar = $('#st');

  // 生成数字键 1-9,* ,0,#
  const keys = ['1','2','3','4','5','6','7','8','9','*','0','#'];
  const pad = $('#keypad');
  keys.forEach(k=>{
    const b=document.createElement('button');
    b.className='kbd'; b.textContent=k; b.dataset.key=k; pad.appendChild(b);
  });

  // 音频池（可被文件选择器覆盖）
  const sounds = {
    open:null, enter:null, standby:null, complete:null,
    key:null, key5_2:null, key5_3:null, ring:null
  };
  const fileMap = {
    '#s-open':'open', '#s-enter':'enter', '#s-standby':'standby', '#s-complete':'complete',
    '#s-key':'key', '#s-ring':'ring', '#s-5-2':'key5_2', '#s-5-3':'key5_3'
  };
  for (const sel in fileMap){
    const el=$(sel);
    el.addEventListener('change',()=>{
      const f=el.files?.[0]; if(!f) return;
      if (sounds[fileMap[sel]]) try { sounds[fileMap[sel]].pause(); } catch{}
      const url=URL.createObjectURL(f);
      const a=new Audio(url); a.preload='auto'; sounds[fileMap[sel]]=a;
    });
  }

  // 播放器
  let unlocked=false; // 首次点击后解锁并播放 open phone
  let ringTimer=null; // 铃声循环控制（手动循环，避免某些浏览器loop失效）
  function play(name,{loop=false,interrupt=true}={}){
    const a=sounds[name]; if(!a) return;
    try{ if(interrupt){ a.currentTime=0; a.pause(); }
      a.play();
      if(loop){
        clearInterval(ringTimer);
        ringTimer=setInterval(()=>{ try{ if(a.ended||a.currentTime>=(a.duration-0.05)){ a.currentTime=0; a.play(); } }catch{}
        },50);
      }
    }catch{}
  }
  function stop(name){ const a=sounds[name]; if(a){ try{ a.pause(); a.currentTime=0; }catch{} } }

  // 交互与规则
  let input="";
  let count5=0; // 记录连续按5次数（仅用于音效层级）
  let transformPending=false; // 输入了555后，按一次Enter进入 stand by；待下一次Enter 完成
  let transformed=false; // 完成态（背景变红）

  function refresh(){ display.value=input; }
  function setTransformed(on){
    transformed=on;
    document.body.style.background = on ? '#2a0000' : 'var(--bg)';
    statusBar.classList.toggle('transform',on);
  }

  // 任意点击解锁 + 自动播 open phone
  document.addEventListener('pointerdown',()=>{
    if(!unlocked){ unlocked=true; play('open'); }
  },{once:true});

  pad.addEventListener('click',e=>{
    const b=e.target.closest('button.kbd'); if(!b) return;
    const k=b.dataset.key;
    input+=k; refresh();

    // 5 的分层按键音
    if(k==='5'){
      count5=(input.endsWith('5'))? (count5+1) : 1; // 连续5计数
      if(count5===1) play('key');
      else if(count5===2) play('key5_2');
      else if(count5>=3) play('key5_3');
    }else{
      count5=0; play('key');
    }
  });

  // ENTER：独立一行按钮
  $('#btn-enter').addEventListener('click',()=>{
    if(!transformPending){
      // 检查是否输入了 555
      if(input.endsWith('555')){
        // 第一次Enter：播 enter -> stand by
        play('enter');
        setTimeout(()=>{ play('standby'); }, 100);
        transformPending=true; // 等待下一次Enter完成
      }else{
        // 普通Enter：只播enter
        play('enter');
      }
    }else{
      // 第二次Enter：不播enter，只播 complete，清空并变色
      play('complete');
      input=""; refresh();
      setTransformed(true);
      transformPending=false;
    }
  });

  // 铃声控制
  $('#btn-ring').addEventListener('click',()=>{ play('ring',{loop:true}); });
  $('#btn-stop').addEventListener('click',()=>{ clearInterval(ringTimer); stop('ring'); });

  // 待定：解除变身，普通按键音
  $('#btn-pending').addEventListener('click',()=>{
    play('key');
    setTransformed(false);
  });

})();
</script>
  
<script>
  // 注册 Service Worker（HTTPS 或 localhost 生效）
  'serviceWorker' in navigator && navigator.serviceWorker.register('./sw.js', { scope: './' });
</script>
</body>
</html>
