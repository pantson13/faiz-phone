<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>FAIZ Phone – 低延迟修正版</title>
<style>
  :root{--bg:#0b0f19;--bg-red:#7f1d1d;--fg:#fff;--panel:#0f172a;--border:#334155;--muted:#94a3b8}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg);
       -webkit-text-size-adjust:100%;touch-action:manipulation;-webkit-user-select:none;user-select:none;}
  .wrap{max-width:480px;margin:0 auto;padding:16px;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .card{width:100%}
  h1{margin:0 0 8px;font-size:18px;text-align:center}
  .display{display:flex;align-items:center;justify-content:space-between;background:#0f172acc;border:1px solid var(--border);border-radius:12px;height:48px;padding:0 12px;margin-bottom:8px}
  .digits{font-weight:700;letter-spacing:.3em}
  .hint{font-size:12px;color:var(--muted)}
  .panel{background:#0f172a99;border:1px solid var(--border);border-radius:16px;padding:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
  .keys{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button.key{width:100%;height:56px;border-radius:14px;border:1px solid var(--border);background:#0f172acc;color:#fff;font-weight:700;font-size:18px;touch-action:manipulation}
  button.key:active{transform:scale(.98)}
  .status{font-size:12px;color:var(--muted);margin:6px 0 10px}
  .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f0f15;color:#fff;touch-action:manipulation}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="card">
    <h1>FAIZ Phone – 15 键（低延迟）</h1>

    <div class="display">
      <div class="digits" id="digits">———</div>
      <div class="hint" id="hint">点任意键解锁并预加载音效</div>
    </div>

    <div class="panel" id="panel">
      <div class="grid3">
        <button class="key" id="btnEnter">ENTER</button><div></div><div></div>
      </div>
      <div class="grid3">
        <button class="key" id="btnRing">☎︎ 铃声</button>
        <button class="key" id="btnUnset">待定</button>
        <button class="key" id="btnStop">⛔︎ 停止</button>
      </div>

      <div class="status" id="status">待机</div>
      <div class="keys" id="keys"></div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== 元素 =====
  const digitsEl = document.getElementById('digits');
  const hintEl   = document.getElementById('hint');
  const statusEl = document.getElementById('status');
  const wrapEl   = document.getElementById('wrap');
  const keysEl   = document.getElementById('keys');

  // ===== 只用你仓库 /assets 的音效（相对路径）=====
  // 若将来想手动替换，再加“浏览器本地覆盖”逻辑；当前以仓库文件为准，杜绝“听到占位哔声”
  const ASSET = {
    openPhone: 'assets/open phone.m4a',
    ring:      'assets/ring.m4a',
    enter:     'assets/enter.m4a',
    key1:      'assets/key1.m4a',
    key5_2:    'assets/key5_2.m4a',
    key5_3:    'assets/key5_3.m4a',
    standBy:   'assets/stand by.m4a',
    complete:  'assets/complete.m4a',
    combo103:  'assets/103.m4a',
    combo106:  'assets/106.m4a',
    combo3821: 'assets/3821.m4a'
  };

  // ===== 低延迟播放器（Web Audio）=====
  let ac=null, masterGain=null, started=false;
  const buffers = new Map(); // key -> AudioBuffer
  let ringNode=null, standNode=null;

  function ensureAC() {
    if (ac) return ac;
    const C = window.AudioContext || window.webkitAudioContext;
    if (!C) return null;
    // iOS Safari 低延迟：interactive（规范定义为“尽可能低延迟”）:contentReference[oaicite:1]{index=1}
    ac = new C({ latencyHint: 'interactive' });
    masterGain = ac.createGain();
    masterGain.gain.value = 1.0;
    masterGain.connect(ac.destination);
    return ac;
  }

  // 预解码（避免 <audio> 启动抖动；用 no-store 绕过旧 SW 缓存）
  async function loadBuffer(key){
    if (buffers.has(key)) return buffers.get(key);
    const url = ASSET[key];
    if (!url) return null;
    const cacheBuster = (url.includes('?') ? '&' : '?') + 'v=' + (self.registration ? '' : Date.now());
    const res = await fetch(url + cacheBuster, { cache: 'no-store' });
    if (!res.ok) return null;
    const arr = await res.arrayBuffer();
    const ctx = ensureAC();
    const buf = await ctx.decodeAudioData(arr);
    buffers.set(key, buf);
    return buf;
  }

  function playBufNow(key, {loop=false} = {}) {
    const ctx = ensureAC(); if(!ctx) return null;
    const buf = buffers.get(key);
    if(!buf) return null;
    const src = ctx.createBufferSource();
    src.buffer = buf; src.loop = !!loop; src.connect(masterGain);
    src.start(0); // 立即启动，最小延迟（已解码）:contentReference[oaicite:2]{index=2}
    return src;
  }

  function safeStop(node){ if(node && node.stop){ try{ node.stop(0); }catch{} } }

  // ===== 首次手势：必须在事件回调里 resume（iOS 规定）=====
  // 注意：resume 必须直接在事件回调栈执行，不能“await/Promise.then”后再调。:contentReference[oaicite:3]{index=3}
  let unlocked = false;
  async function unlockAndPreloadInGesture() {
    if (unlocked) return;
    const ctx = ensureAC();
    try { if (ctx.state === 'suspended') await ctx.resume(); } catch {}
    unlocked = true;
    hintEl.textContent = '已解锁，预加载中…';

    // 预热一次 1 样本静音，部分浏览器可进一步减少后续启动抖动
    try {
      const empty = ctx.createBuffer(1, 1, ctx.sampleRate);
      const node = ctx.createBufferSource(); node.buffer=empty; node.connect(ctx.destination); node.start(0);
    } catch {}

    // 并行预解码所有音效
    await Promise.all(Object.keys(ASSET).map(k => loadBuffer(k).catch(()=>null)));

    hintEl.textContent = '已解锁';
    // 解锁后立即播开机音（你的文件）
    const src = playBufNow('openPhone');
    if (!src) statusEl.textContent = '⚠️ 找不到 open phone 音频';
  }

  // ===== 规则状态 =====
  let fiveCount=0, buf='', armedStand=false, transformed=false;
  const showDigits = (s)=>{ digitsEl.textContent=(s||'').padStart(3,'—').slice(-3); };
  const setStatus  = (t)=>{ statusEl.textContent=t; };

  async function push(k){
    // 首次用户手势触发解锁+预解码
    await unlockAndPreloadInGesture();

    if(k==='*'||k==='#'){ playBufNow('key1'); return; }

    if(k==='5'){
      fiveCount=(fiveCount%3)+1;
      if(fiveCount===1) playBufNow('key1');
      else if(fiveCount===2) playBufNow('key5_2');
      else playBufNow('key5_3');
    }else{
      fiveCount=0; playBufNow('key1');
    }

    buf=(buf+k).slice(-4); showDigits(buf);

    if(buf.endsWith('103'))  { setStatus('特殊：103');  playBufNow('combo103'); }
    if(buf.endsWith('106'))  { setStatus('特殊：106');  playBufNow('combo106'); }
    if(buf.endsWith('3821')) { setStatus('特殊：3821'); playBufNow('combo3821'); }
    if(buf.endsWith('555'))  { setStatus('已输入 555'); }
  }

  async function onEnter(){
    await unlockAndPreloadInGesture();

    if (armedStand){
      safeStop(standNode); standNode=null;
      const src = playBufNow('complete');
      const finish=()=>{ transformed=true; wrapEl.style.background='var(--bg-red)'; buf=''; showDigits(''); setStatus('完成'); };
      if (src) src.onended = finish; else setTimeout(finish,380);
      armedStand=false; return;
    }

    playBufNow('enter');

    if (buf.endsWith('555')){
      safeStop(standNode); standNode=null;
      standNode = playBufNow('standBy'); // 不循环
      if (standNode) standNode.onended = ()=>{ standNode=null; };
      armedStand = true; setStatus('stand by');
    } else {
      setStatus('ENTER');
    }
  }

  async function ringStart(){
    await unlockAndPreloadInGesture();
    safeStop(ringNode); ringNode=null;
    ringNode = playBufNow('ring', { loop:true });
    setStatus('响铃中');
  }
  function ringStop(){ safeStop(ringNode); ringNode=null; setStatus('铃声停止'); }
  function onUnset(){ playBufNow('key1'); transformed=false; wrapEl.style.background='var(--bg)'; setStatus('解除变身'); }

  // 键盘
  ['1','2','3','4','5','6','7','8','9','*','0','#'].forEach(k=>{
    const b=document.createElement('button'); b.className='key'; b.textContent=k; b.onclick=()=>{ push(k); }; keysEl.appendChild(b);
  });
  document.getElementById('btnEnter').onclick=onEnter;
  document.getElementById('btnRing').onclick=ringStart;
  document.getElementById('btnStop').onclick=ringStop;
  document.getElementById('btnUnset').onclick=onUnset;

  // 首次手势监听：**必须**直接在事件回调里调用（iOS autoplay 策略）:contentReference[oaicite:4]{index=4}
  ['pointerdown','touchend','click'].forEach(evt=>{
    document.addEventListener(evt, () => { unlockAndPreloadInGesture(); }, { once:true, passive:true });
  });

  // 保险：阻止手势缩放
  ['gesturestart','gesturechange','gestureend'].forEach(ev=>{
    document.addEventListener(ev, e=>{ e.preventDefault(); }, {passive:false});
  });

  // 显示面板提示当前是否找到了你的音频（可选：打开注释进行调试）
  // window.__dumpBuffers = () => console.log([...buffers.keys()]);
})();
</script>
</body>
</html>
