<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>FAIZ Phone â€“ ä½å»¶è¿Ÿ(çº¯HTML)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0f19" />
<style>
  :root{--bg:#0b0f19;--bg-red:#7f1d1d;--fg:#fff;--panel:#0f172a;--border:#334155;--muted:#94a3b8}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg); color:var(--fg);
    -webkit-text-size-adjust:100%;
    touch-action:manipulation; /* é˜²åŒå‡»æ”¾å¤§ */
    -webkit-user-select:none; user-select:none;
  }
  .wrap{max-width:480px;margin:0 auto;padding:16px;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .card{width:100%}
  h1{margin:0 0 8px;font-size:18px;text-align:center}
  .display{display:flex;align-items:center;justify-content:space-between;background:#0f172acc;border:1px solid var(--border);border-radius:12px;height:48px;padding:0 12px;margin-bottom:8px}
  .digits{font-weight:700;letter-spacing:.3em}
  .hint{font-size:12px;color:var(--muted)}
  .panel{background:#0f172a99;border:1px solid var(--border);border-radius:16px;padding:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
  .keys{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button.key{
    width:100%;height:56px;border-radius:14px;border:1px solid var(--border);
    background:#0f172acc;color:#fff;font-weight:700;font-size:18px;touch-action:manipulation;
  }
  button.key:active{transform:scale(.98)}
  .status{font-size:12px;color:var(--muted);margin:6px 0 10px}
  .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f0f15;color:#fff;touch-action:manipulation}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
  .modal>.box{width:min(92vw,720px);max-height:86vh;overflow:auto;background:#0b0f1a;border:1px solid var(--border);border-radius:16px;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .muted{font-size:12px;color:var(--muted)}
  .drop{border:1px dashed var(--border);border-radius:12px;padding:16px;text-align:center;color:var(--muted);margin-bottom:12px}
  .pair{border:1px solid var(--border);border-radius:12px;padding:10px}
  .tag{font-size:12px;color:var(--muted)}
  .ok{color:#22c55e}.warn{color:#fbbf24}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="card">
    <h1>FAIZ Phone â€“ 15 é”®æµ‹è¯•ï¼ˆä½å»¶è¿Ÿï¼‰</h1>

    <div class="display">
      <div class="digits" id="digits">â€”â€”â€”</div>
      <div class="hint" id="hint">ç‚¹ä»»æ„é”®è§£é”å¹¶é¢„åŠ è½½éŸ³æ•ˆ</div>
    </div>

    <div class="panel" id="panel">
      <!-- ç¬¬ä¸€è¡Œï¼šENTER å•ç‹¬ä¸€è¡Œ -->
      <div class="grid3">
        <button class="key" id="btnEnter">ENTER</button>
        <div></div><div></div>
      </div>
      <!-- ç¬¬äºŒè¡Œï¼šé“ƒå£° / å¾…å®š / åœæ­¢ -->
      <div class="grid3">
        <button class="key" id="btnRing">â˜ï¸ é“ƒå£°</button>
        <button class="key" id="btnUnset">å¾…å®š</button>
        <button class="key" id="btnStop">â›”ï¸ åœæ­¢</button>
      </div>

      <div class="status" id="status">å¾…æœº</div>
      <!-- æ•°å­—é”®ç›˜ 3Ã—4 -->
      <div class="keys" id="keys"></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnBrowser">ğŸ“‚ æµè§ˆ/ç®¡ç†éŸ³æ•ˆ</button>
      <button class="btn" id="btnExport">å¯¼å‡º JSON</button>
      <button class="btn" id="btnClear">æ¸…ç©º</button>
    </div>
  </div>
</div>

<!-- éŸ³æ•ˆæµè§ˆ/ç®¡ç† -->
<div class="modal" id="modal">
  <div class="box">
    <div class="row"><div>æµè§ˆå’Œç®¡ç†éŸ³æ•ˆ</div><div style="flex:1"></div><button class="btn" id="btnClose">å…³é—­</button></div>
    <div class="row">
      <label class="btn">æ‰¹é‡é€‰æ‹©æ–‡ä»¶<input type="file" id="fileMulti" style="display:none" multiple accept="audio/*" /></label>
      <div class="muted">è‡ªåŠ¨åŒ¹é…ï¼šopen phone / ring / enter / key1 / key5_2 / key5_3 / stand by / complete / 103 / 106 / 3821</div>
    </div>
    <div class="drop" id="drop">ç‚¹å‡»æˆ–æ‹–å…¥éŸ³é¢‘æ–‡ä»¶åˆ°è¿™é‡Œï¼Œè‡ªåŠ¨åŒ¹é…å¹¶ä¿å­˜ï¼ˆä¿å­˜åœ¨æœ¬æœºï¼‰</div>
    <div id="pairs" class="grid3" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"></div>
  </div>
</div>

<script>
(function(){
  const digitsEl = document.getElementById('digits');
  const hintEl   = document.getElementById('hint');
  const statusEl = document.getElementById('status');
  const wrapEl   = document.getElementById('wrap');
  const keysEl   = document.getElementById('keys');

  // æœ¬æœºé…ç½®ï¼ˆå¯è¢«â€œæµè§ˆ/ç®¡ç†â€è¦†ç›–ï¼‰
  const cfg = (()=>{ try{ return JSON.parse(localStorage.getItem('faiz_cfg_v1')||'{}'); }catch{ return {}; } })();
  const saveCfg = ()=>{ try{ localStorage.setItem('faiz_cfg_v1', JSON.stringify(cfg)); }catch(e){} };

  // é»˜è®¤éŸ³æ•ˆï¼ˆç›¸å¯¹è·¯å¾„ï¼ŒæŒ‡å‘ /assetsï¼‰
  const defaults = {
    openPhone:  'assets/open phone.m4a',
    ring:       'assets/ring.m4a',
    enter:      'assets/enter.m4a',
    key1:       'assets/key1.m4a',
    key5_2:     'assets/key5_2.m4a',
    key5_3:     'assets/key5_3.m4a',
    standBy:    'assets/stand by.m4a',
    complete:   'assets/complete.m4a',
    combo103:   'assets/103.m4a',
    combo106:   'assets/106.m4a',
    combo3821:  'assets/3821.m4a'
  };
  for (const k in defaults) if (!cfg[k]) cfg[k] = defaults[k];
  saveCfg();

  // ===== ä½å»¶è¿Ÿæ’­æ”¾å™¨ï¼ˆWeb Audioï¼‰=====
  let ac=null, started=false;
  let masterGain=null;
  const buffers = new Map();  // key -> AudioBuffer
  let ringNode=null, standNode=null;

  function ensureAC(){
    if (ac) return ac;
    const C = window.AudioContext || window.webkitAudioContext;
    if(!C) return null;
    // å€¾å‘ä½å»¶è¿Ÿ
    ac = new C({ latencyHint: 'interactive' }); // MDN æ¨èç”¨æ³•
    masterGain = ac.createGain();
    masterGain.gain.value = 1.0;
    masterGain.connect(ac.destination);
    return ac;
  }

  async function loadBuffer(key){
    if (buffers.has(key)) return buffers.get(key);
    const url = cfg[key];
    if (!url) return null;
    // æ”¯æŒ DataURL å’Œç›¸å¯¹è·¯å¾„
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    const ctx = ensureAC();
    const buf = await ctx.decodeAudioData(arr);
    buffers.set(key, buf);
    return buf;
  }

  async function playBuf(key, { loop=false } = {}){
    const ctx = ensureAC(); if(!ctx) return null;
    const buf = await loadBuffer(key);
    if(!buf) return null;
    const src = ctx.createBufferSource();
    src.buffer = buf;
    src.loop = !!loop;
    src.connect(masterGain);
    src.start(0); // ä½å»¶è¿Ÿå¯åŠ¨
    return src;
  }

  // å…œåº• beepï¼ˆå½“æŸä¸ªé”®æ²¡æ–‡ä»¶æ—¶ï¼‰
  function beep(opt){
    const ctx=ensureAC(); if(!ctx) return;
    const o=opt||{}, osc=ctx.createOscillator(), g=ctx.createGain();
    osc.type=o.type||'square'; osc.frequency.value=o.freq||520; g.gain.value=(o.vol==null?0.22:o.vol);
    osc.connect(g).connect(ctx.destination); osc.start();
    setTimeout(()=>{ try{osc.stop();}catch{} }, o.ms||120);
  }

  // ç»Ÿä¸€æ’­æ”¾å…¥å£ï¼ˆä¼˜å…ˆç”¨ bufferï¼ŒåŠ è½½å¤±è´¥å† beepï¼‰
  async function playKey(name, {loop=false} = {}){
    try{
      const src = await playBuf(name, { loop });
      if (!src) {
        if(name==='enter')     beep({freq:560,ms:160,type:'sawtooth',vol:0.26});
        else if(name==='complete')  beep({freq:260,ms:360,type:'square',vol:0.30});
        else if(name==='standBy')   beep({freq:720,ms:260,type:'triangle',vol:0.28});
        else beep();
      }
      return src;
    }catch(e){ beep(); return null; }
  }

  function safeStop(node){ if(node && node.stop){ try{ node.stop(0); }catch{} } }

  // ===== è§£é” & é¢„åŠ è½½ =====
  async function unlockAndPreload(){
    if (started) return;
    started = true;
    const ctx = ensureAC();
    if (ctx.state === 'suspended') { try{ await ctx.resume(); }catch{} }

    hintEl.textContent='å·²è§£é”ï¼Œæ­£åœ¨é¢„åŠ è½½â€¦';

    // é¢„çƒ­ï¼šæ’­æ”¾ä¸€ä¸ªæçŸ­çš„é™éŸ³ç¼“å†²ï¼Œå¸®åŠ©åç»­â€œé›¶å»¶è¿Ÿâ€å¯åŠ¨ï¼ˆç¬¦åˆå„æµè§ˆå™¨ç­–ç•¥ï¼‰ 
    try{
      const empty = ctx.createBuffer(1, 1, ctx.sampleRate);
      const node = ctx.createBufferSource(); node.buffer=empty; node.connect(ctx.destination); node.start(0);
    }catch{}

    // å¹¶è¡Œé¢„åŠ è½½æ‰€æœ‰é”®ä½éŸ³é¢‘ï¼Œé¦–è§¦åç«‹å³å¼€å§‹
    const keysToPreload = ['openPhone','ring','enter','key1','key5_2','key5_3','standBy','complete','combo103','combo106','combo3821'];
    await Promise.all(keysToPreload.map(k=>loadBuffer(k).catch(()=>null)));

    hintEl.textContent='å·²è§£é”';
    // å¼€æœºéŸ³
    playKey('openPhone').catch(()=>{});
  }

  // ===== è§„åˆ™ä¸ UI =====
  let fiveCount=0, buf=''; let armedStand=false; let transformed=false;

  function showDigits(s){ digitsEl.textContent=(s||'').padStart(3,'â€”').slice(-3); }
  function setStatus(t){ statusEl.textContent=t; }

  async function push(k){
    await unlockAndPreload();

    if(k==='*'||k==='#'){ await playKey('key1'); return; }

    if(k==='5'){
      fiveCount=(fiveCount%3)+1;
      if(fiveCount===1) await playKey('key1');
      else if(fiveCount===2) await playKey('key5_2');
      else await playKey('key5_3');
    }else{
      fiveCount=0; await playKey('key1');
    }

    buf=(buf+k).slice(-4); showDigits(buf);

    if(buf.endsWith('103'))  { setStatus('ç‰¹æ®Šï¼š103');  await playKey('combo103'); }
    if(buf.endsWith('106'))  { setStatus('ç‰¹æ®Šï¼š106');  await playKey('combo106'); }
    if(buf.endsWith('3821')) { setStatus('ç‰¹æ®Šï¼š3821'); await playKey('combo3821'); }
    if(buf.endsWith('555'))  { setStatus('å·²è¾“å…¥ 555'); }
  }

  async function onEnter(){
    await unlockAndPreload();

    if (armedStand){
      safeStop(standNode); standNode=null;
      const src = await playKey('complete');
      const finish=()=>{ transformed=true; wrapEl.style.background='var(--bg-red)'; buf=''; showDigits(''); setStatus('å®Œæˆ'); };
      if(src){ src.onended=finish; } else { setTimeout(finish, 380); }
      armedStand=false; return;
    }

    await playKey('enter');

    if (buf.endsWith('555')){
      safeStop(standNode); standNode=null;
      standNode = await playKey('standBy'); // ä¸å¾ªç¯
      if(standNode){ standNode.onended = ()=>{ standNode=null; }; }
      armedStand=true; setStatus('stand by');
    }else{
      setStatus('ENTER');
    }
  }

  async function ringStart(){
    await unlockAndPreload();
    safeStop(ringNode); ringNode=null;
    ringNode = await playKey('ring', { loop:true });
    setStatus('å“é“ƒä¸­');
  }
  function ringStop(){ safeStop(ringNode); ringNode=null; setStatus('é“ƒå£°åœæ­¢'); }
  async function onUnset(){ await playKey('key1'); transformed=false; wrapEl.style.background='var(--bg)'; setStatus('è§£é™¤å˜èº«'); }

  // é”®ç›˜
  ['1','2','3','4','5','6','7','8','9','*','0','#'].forEach(k=>{
    const b=document.createElement('button'); b.className='key'; b.textContent=k; b.onclick=()=>{ push(k); }; keysEl.appendChild(b);
  });
  document.getElementById('btnEnter').onclick=onEnter;
  document.getElementById('btnRing').onclick=ringStart;
  document.getElementById('btnStop').onclick=ringStop;
  document.getElementById('btnUnset').onclick=onUnset;

  // éŸ³æ•ˆç®¡ç†ï¼ˆå’Œä½ ä¹‹å‰ä¸€è‡´ï¼‰
  const keyList=[
    ['openPhone','Open phone'],['ring','é“ƒå£°'],['enter','ENTER'],['key1','æ™®é€šæŒ‰é”®'],
    ['key5_2','5(ç¬¬äºŒæ¬¡)'],['key5_3','5(ç¬¬ä¸‰æ¬¡)'],['standBy','Stand by'],
    ['complete','Complete'],['combo103','103'],['combo106','106'],['combo3821','3821']
  ];
  const nameMap={
    'open phone':'openPhone','openphone':'openPhone','open_phone':'openPhone',
    'ring':'ring','enter':'enter','key1':'key1',
    'key5_2':'key5_2','key5-2':'key5_2','5_2':'key5_2',
    'key5_3':'key5_3','key5-3':'key5_3','5_3':'key5_3',
    'stand by':'standBy','standby':'standBy','stand_by':'standBy','stay':'standBy',
    'complete':'complete',
    '103':'combo103','combo103':'combo103',
    '106':'combo106','combo106':'combo106',
    '3821':'combo3821','combo3821':'combo3821'
  };
  const pairsEl=document.getElementById('pairs');
  function baseNoExt(n){ const i=n.lastIndexOf('.'); return (i>=0?n.slice(0,i):n).toLowerCase().trim(); }
  function refreshPairs(){
    pairsEl.innerHTML='';
    keyList.forEach(([key,label])=>{
      const d=document.createElement('div'); d.className='pair';
      d.innerHTML = `<div style="font-weight:600">${label} <span class="tag">(${key})</span></div>
        <div class="tag">${cfg[key]?'<span class="ok">âœ… å·²é…ç½®</span>':'<span class="warn">âš ï¸ æœªé…ç½®</span>'}</div>
        <div class="row">
          <label class="btn">é€‰æ‹©æ–‡ä»¶<input type="file" style="display:none" accept="audio/*" /></label>
          <button class="btn" data-act="preview">è¯•å¬</button>
          <button class="btn" data-act="clear">æ¸…é™¤</button>
        </div>`;
      const input=d.querySelector('input[type=file]');
      input.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{ cfg[key]=r.result; saveCfg(); buffers.delete(key); refreshPairs(); };
        r.readAsDataURL(f);
      };
      d.querySelector('[data-act=preview]').onclick=async()=>{ const src=await playKey(key); if(!src) setStatus('æœªé…ç½®ï¼š'+key); };
      d.querySelector('[data-act=clear]').onclick=()=>{ delete cfg[key]; saveCfg(); buffers.delete(key); refreshPairs(); };
      pairsEl.appendChild(d);
    });
  }
  refreshPairs();

  // æ‰¹é‡å¯¼å…¥
  const drop=document.getElementById('drop'), multi=document.getElementById('fileMulti');
  drop.addEventListener('click',()=>multi.click());
  drop.ondragover=(e)=>{ e.preventDefault(); };
  drop.ondrop=(e)=>{ e.preventDefault(); if(e.dataTransfer?.files){ autoMapList(e.dataTransfer.files); } };
  multi.onchange=(e)=>{ const fs=e.target.files; if(fs&&fs.length) autoMapList(fs); e.target.value=''; };
  function autoMapList(files){
    let matched=0;
    [...files].forEach(f=>{
      const r=new FileReader();
      r.onload=()=>{ const key=nameMap[ baseNoExt(f.name) ]; if(key){ cfg[key]=r.result; matched++; saveCfg(); buffers.delete(key); refreshPairs(); } };
      r.readAsDataURL(f);
    });
    setStatus('å·²é€‰æ‹© '+files.length+' ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨åŒ¹é… '+matched+' ä¸ª');
  }

  // é¦–æ¬¡ç”¨æˆ·æ‰‹åŠ¿ï¼šè§£é” + é¢„åŠ è½½ + å¼€æœºéŸ³ï¼ˆiOS autoplay ç­–ç•¥è¦æ±‚æœ‰æ‰‹åŠ¿ï¼‰
  ['pointerdown','touchend','click'].forEach(evt=>{
    document.addEventListener(evt, ()=>unlockAndPreload(), { once:true, passive:true });
  });

  // ä¿é™©ï¼šæ‹¦æˆª iOS æ‰‹åŠ¿ç¼©æ”¾
  ['gesturestart','gesturechange','gestureend'].forEach(ev=>{
    document.addEventListener(ev, e=>{ e.preventDefault(); }, {passive:false});
  });

  // æ³¨å†Œ SWï¼ˆå¯é€‰ï¼›å¦‚æœä½ å·²ç»æœ‰ sw.jsï¼Œä¼šè‡ªåŠ¨ç¦»çº¿ç¼“å­˜ï¼‰
  'serviceWorker' in navigator && navigator.serviceWorker.register('./sw.js', { scope: './' });
})();
</script>
</body>
</html>
