<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>FAIZ Phone</title>
<style>
  :root{ --bg:#0b0f19; }
  html,body{
    margin:0; background:var(--bg); color:#fff; -webkit-text-size-adjust:100%;
    -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
  }
  *{ -webkit-tap-highlight-color: transparent; }

  .page{
    min-height:100vh; display:flex; flex-direction:column; align-items:center;
    gap:24px; padding:24px 0 80px;
  }

  /* 容器不再固定比例，改为由 JS 根据图片真实比例动态设置高度，避免热区错位 */
  .phone-wrap{
    position:relative;
    width:min(92vw, 520px);
    background:#000;
    border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.45);
    overflow:hidden; touch-action:manipulation;
  }

  .phone-bg{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:cover; object-position:center; display:block;
  }

  .img-missing{
    position:absolute; left:0; right:0; top:0;
    background:#7f1d1d; color:#fff; font-size:12px;
    padding:6px 10px; text-align:center; display:none; z-index:5;
  }

  /* 交互热区：完全透明、无边框、无 outline */
  .hot{
    position:absolute; display:block; border-radius:10px;
    background:transparent; border:none; outline:none;
    -webkit-appearance:none; appearance:none;
  }
  .hot:focus, .hot:active{ outline:none; box-shadow:none; border:none; }

  /* —— 键区坐标（百分比），根据你的图来。如果还差一点，只需改这些数值 —— */
  #btnEnter{ left:26.9%; width:46%;  top:56.6%; height:4.2%; }     /* ENTER */
  #btnRing { left:21.0%; width:17%;  top:63.7%; height:5.0%; }     /* 铃声 */
  #btnClear{ left:41.7%; width:17%;  top:63.7%; height:5.0%; }     /* クリア */
  #btnStop { left:62.3%; width:17%;  top:63.7%; height:5.0%; }     /* 停止 */

  #k1{ left:26.4%; width:14%; top:69.7%; height:5.0%;}
  #k2{ left:44.0%; width:14%; top:69.7%; height:5.0%;}
  #k3{ left:61.6%; width:14%; top:69.7%; height:5.0%;}
  #k4{ left:26.4%; width:14%; top:76.0%; height:5.0%;}
  #k5{ left:44.0%; width:14%; top:76.0%; height:5.0%;}
  #k6{ left:61.6%; width:14%; top:76.0%; height:5.0%;}
  #k7{ left:26.4%; width:14%; top:82.3%; height:5.0%;}
  #k8{ left:44.0%; width:14%; top:82.3%; height:5.0%;}
  #k9{ left:61.6%; width:14%; top:82.3%; height:5.0%;}
  #kStar{ left:26.4%; width:14%; top:88.6%; height:5.0%;}
  #k0{    left:44.0%; width:14%; top:88.6%; height:5.0%;}
  #kHash{ left:61.6%; width:14%; top:88.6%; height:5.0%;}
</style>
</head>
<body>
<div class="page">

  <div class="phone-wrap" id="wrap">
    <div class="img-missing" id="imgMissing">
      背景图未加载。请确认 <code>assets/ui.jpg</code> 存在（区分大小写）。
    </div>
    <img id="bg" class="phone-bg" alt="UI" />

    <!-- 功能键 -->
    <button id="btnEnter" class="hot" aria-label="ENTER"></button>
    <button id="btnRing"  class="hot" aria-label="铃声"></button>
    <button id="btnClear" class="hot" aria-label="クリア"></button>
    <button id="btnStop"  class="hot" aria-label="停止铃声"></button>

    <!-- 数字键盘 -->
    <button id="k1" class="hot" data-k="1"></button>
    <button id="k2" class="hot" data-k="2"></button>
    <button id="k3" class="hot" data-k="3"></button>
    <button id="k4" class="hot" data-k="4"></button>
    <button id="k5" class="hot" data-k="5"></button>
    <button id="k6" class="hot" data-k="6"></button>
    <button id="k7" class="hot" data-k="7"></button>
    <button id="k8" class="hot" data-k="8"></button>
    <button id="k9" class="hot" data-k="9"></button>
    <button id="kStar" class="hot" data-k="*"></button>
    <button id="k0" class="hot" data-k="0"></button>
    <button id="kHash" class="hot" data-k="#"></button>
  </div>

</div>

<script>
(() => {
  /* ===== 背景图（固定 assets/ui.jpg）并按真实比例设置容器高度，避免错位 ===== */
  const UI_FILE = 'assets/ui.jpg';
  const wrap = document.getElementById('wrap');
  const bgImg = document.getElementById('bg');
  const imgMissing = document.getElementById('imgMissing');

  function fitWrapToImage(){
    // 用图片天然宽高计算比例，按当前 wrap 宽度设定高度
    const W = wrap.clientWidth;
    const r = bgImg.naturalHeight / bgImg.naturalWidth; // 高/宽
    if (isFinite(r) && r > 0){
      wrap.style.height = (W * r) + 'px';
    }
  }
  bgImg.onload = () => { imgMissing.style.display = 'none'; fitWrapToImage(); };
  bgImg.onerror = () => { imgMissing.style.display = 'block'; };
  bgImg.src = UI_FILE;
  // 窗口尺寸变化时也自适应一次
  window.addEventListener('resize', ()=>{ if(bgImg.complete && bgImg.naturalWidth) fitWrapToImage(); });

  /* ===== 声音名 → 基名（不带后缀），播放器与规则沿用上版（省略注释） ===== */
  const SND = {
    openPhone:'open phone', ringStart:'ring', enter:'enter',
    key:'key1', key5_2:'key5_2', key5_3:'key5_3',
    standBy:'stand by', complete:'complete', release:'release',
    error:'error', ready:'ready', exceed:'exceed charge',
    weaponHit:'weaponHit'
  };

  let started=false, ringing=null, AC=null;
  const mimeByExt = { m4a:'audio/mp4', mp3:'audio/mpeg', wav:'audio/wav', mp4:'audio/mp4' };
  const extOrder = ['m4a','mp3','wav','mp4'];

  function candidates(base){
    const t = document.createElement('audio'); const out=[];
    for(const ext of extOrder){ const mime=mimeByExt[ext]||''; if(!mime || t.canPlayType(mime)!=='') out.push(`assets/${base}.${ext}`); }
    return out;
  }

  const waBuf=new Map(), waFail=new Set();
  async function waLoadOnce(name){
    if(waBuf.has(name) || waFail.has(name)) return;
    const base=SND[name]; if(!base){ waFail.add(name); return; }
    for(const url of candidates(base)){
      try{
        const res=await fetch(url,{cache:'force-cache'}); if(!res.ok) continue;
        const arr=await res.arrayBuffer(); const buf=await AC.decodeAudioData(arr);
        waBuf.set(name, buf); return;
      }catch{}
    }
    waFail.add(name);
  }
  function waPlay(name, {loop=false, delayMs=0}={}){
    const buf=waBuf.get(name); if(!buf) return null;
    const src=AC.createBufferSource(), g=AC.createGain();
    src.buffer=buf; src.loop=!!loop; src.connect(g).connect(AC.destination);
    const start=()=>src.start(); if(delayMs>0) setTimeout(start, delayMs); else start();
    return { stop:()=>{ try{src.stop();}catch{} } };
  }
  function htmlPlay(name, {loop=false, delayMs=0}={}){
    const base=SND[name]; if(!base) return null;
    const urls=candidates(base); if(!urls.length) return null;
    const a=new Audio(); a.preload='auto'; a.playsInline=true; a.loop=!!loop;
    const go=i=>{ if(i>=urls.length) return;
      a.onerror=()=>go(i+1); a.src=urls[i];
      const start=()=>a.play().catch(()=>{}); if(delayMs>0) setTimeout(start, delayMs); else start();
    }; go(0);
    return { stop:()=>{ try{a.pause();}catch{} } };
  }
  function beep(freq=520, ms=90, type='square', vol=0.22){
    try{
      const C=window.AudioContext||window.webkitAudioContext; if(!C) return;
      const ac=AC||new C(); AC=ac;
      const o=ac.createOscillator(), g=ac.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g).connect(ac.destination); o.start(); setTimeout(()=>{ try{o.stop();}catch{} }, ms);
    }catch{}
  }
  function play(name, opts={}){
    if(AC && waBuf.has(name)){ const h=waPlay(name, opts); if(h) return h; }
    const h2=htmlPlay(name, opts); if(h2) return h2;
    beep(); return null;
  }
  function stopRinging(){ if(ringing){ try{ringing.stop?.();}catch{} ringing=null; } }
  function anyKeyInterruptRing(){ stopRinging(); }

  async function unlock(){
    if(started) return; started=true;
    const C=window.AudioContext||window.webkitAudioContext;
    if(C){ try{
      AC=new C();
      const preload=['openPhone','enter','key','key5_2','key5_3','standBy','complete','release','error','ready','exceed','weaponHit','ringStart'];
      await Promise.all(preload.map(n=>waLoadOnce(n)));
    }catch{} }
    play('openPhone');
  }

  /* ===== 规则 ===== */
  let buf='', transformed=false, armedStandby=false, armedReady=false;

  function pushKey(k){
    unlock(); anyKeyInterruptRing();
    if(k==='*'){ play('weaponHit'); buf=(buf+k).slice(-4); return; }
    if(k==='5'){
      const fiveCount=(buf.match(/5+$/)?.[0]?.length||0)+1;
      if(fiveCount===1) play('key'); else if(fiveCount===2) play('key5_2'); else play('key5_3');
    }else{ play('key'); }
    buf=(buf+k).slice(-4);
  }

  function onEnter(){
    unlock(); anyKeyInterruptRing();
    const last3=buf.slice(-3);

    if(transformed && (last3==='106'||last3==='103')){ play('enter'); return; }
    if(armedStandby){ armedStandby=false; play('complete'); transformed=true; armedReady=false; return; }

    if(transformed){
      if(!armedReady){ play('ready'); armedReady=true; return; }
      play('enter'); play('exceed',{delayMs:120}); armedReady=false; return;
    }

    if(last3==='555'){ play('enter'); play('standBy'); armedStandby=true; return; }
    if(last3==='106'||last3==='103'){ play('enter'); return; }

    if(buf.length===3 && last3!=='3821'){
      play('enter'); play('error',{delayMs:40});
      buf=''; armedStandby=false; armedReady=false; return;
    }
    play('enter');
  }

  function onRingStart(){ unlock(); stopRinging(); ringing=play('ringStart',{loop:true}); }
  function onRingStop(){ unlock(); play('key'); stopRinging(); }
  function onClear(){
    unlock(); anyKeyInterruptRing();
    play('key'); play('release',{delayMs:40});
    transformed=false; armedStandby=false; armedReady=false; buf='';
  }

  // 绑定（pointerdown 规避点击延迟）
  const bind=(el,fn)=>{ el.addEventListener('pointerdown',e=>{ e.preventDefault(); fn(); }, {passive:false}); };
  bind(document.getElementById('btnEnter'), onEnter);
  bind(document.getElementById('btnRing'),  onRingStart);
  bind(document.getElementById('btnStop'),  onRingStop);
  bind(document.getElementById('btnClear'), onClear);
  ['k1','k2','k3','k4','k5','k6','k7','k8','k9','kStar','k0','kHash'].forEach(id=>{
    bind(document.getElementById(id), ()=>pushKey(document.getElementById(id).dataset.k));
  });

  // 首次手势 → 解锁音频并预热
  ['pointerdown','touchstart','click','keydown'].forEach(ev=>{
    window.addEventListener(ev, ()=>{ unlock(); }, {once:true, passive:true});
  });
})();
</script>
</body>
</html>
