<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>FAIZ Phone</title>
<style>
  :root{ --bg:#0b0f19; }
  html,body{margin:0;background:var(--bg);color:#fff;-webkit-text-size-adjust:100%}
  .page{ min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:24px; padding:24px 0 80px; }

  /* 手机图容器：相对定位，内部热区绝对定位（百分比），随图自适应缩放 */
  .phone-wrap{
    position:relative;
    width:min(92vw, 520px);
    aspect-ratio: 708 / 1536;               /* 按你的图比例 */
    background:#000 url('assets/phone-ui.jpg') center/cover no-repeat;
    border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.45);
    overflow:hidden; touch-action:manipulation;
  }

  .hot{
    position:absolute; display:block; border-radius:10px;
    background:rgba(255,255,255,0);
  }
  .hot:active{ outline:2px solid rgba(255,255,255,.25); }

  /* —— 键区坐标（百分比），如需微调改这里 —— */
  #btnEnter{ left:26.9%; width:46%;  top:56.6%; height:4.2%; }     /* ENTER */
  #btnRing { left:21.0%; width:17%;  top:63.7%; height:5.0%; }     /* 铃声 */
  #btnClear{ left:41.7%; width:17%;  top:63.7%; height:5.0%; }     /* クリア */
  #btnStop { left:62.3%; width:17%;  top:63.7%; height:5.0%; }     /* 停止 */

  #k1{ left:26.4%; width:14%; top:69.7%; height:5.0%;}
  #k2{ left:44.0%; width:14%; top:69.7%; height:5.0%;}
  #k3{ left:61.6%; width:14%; top:69.7%; height:5.0%;}
  #k4{ left:26.4%; width:14%; top:76.0%; height:5.0%;}
  #k5{ left:44.0%; width:14%; top:76.0%; height:5.0%;}
  #k6{ left:61.6%; width:14%; top:76.0%; height:5.0%;}
  #k7{ left:26.4%; width:14%; top:82.3%; height:5.0%;}
  #k8{ left:44.0%; width:14%; top:82.3%; height:5.0%;}
  #k9{ left:61.6%; width:14%; top:82.3%; height:5.0%;}
  #kStar{ left:26.4%; width:14%; top:88.6%; height:5.0%;}
  #k0{    left:44.0%; width:14%; top:88.6%; height:5.0%;}
  #kHash{ left:61.6%; width:14%; top:88.6%; height:5.0%;}

  .footer{ width:min(92vw,520px); color:#9aa4b2; font-size:13px; line-height:1.6; padding:8px 2px 0; }
</style>
</head>
<body>
<div class="page">

  <div class="phone-wrap" id="wrap">
    <!-- 功能键 -->
    <button id="btnEnter" class="hot" aria-label="ENTER"></button>
    <button id="btnRing"  class="hot" aria-label="铃声"></button>
    <button id="btnClear" class="hot" aria-label="クリア"></button>
    <button id="btnStop"  class="hot" aria-label="停止铃声"></button>

    <!-- 数字键盘 -->
    <button id="k1" class="hot" data-k="1"></button>
    <button id="k2" class="hot" data-k="2"></button>
    <button id="k3" class="hot" data-k="3"></button>
    <button id="k4" class="hot" data-k="4"></button>
    <button id="k5" class="hot" data-k="5"></button>
    <button id="k6" class="hot" data-k="6"></button>
    <button id="k7" class="hot" data-k="7"></button>
    <button id="k8" class="hot" data-k="8"></button>
    <button id="k9" class="hot" data-k="9"></button>
    <button id="kStar" class="hot" data-k="*"></button>
    <button id="k0" class="hot" data-k="0"></button>
    <button id="kHash" class="hot" data-k="#"></button>
  </div>

  <div class="footer">
    首次点击将解锁音频。把音效放在 <code>assets/</code> 下即可：支持 <code>.m4a</code>、<code>.mp3</code>、<code>.wav</code>、<code>.mp4</code>（同名任选其一或都放；会自动择优/回退）。
  </div>
</div>

<script>
(() => {
  /* ========== 声音名 → “文件基名”（不带后缀） ========== */
  const SND = {
    openPhone:  'open phone',
    ringStart:  'ring',
    enter:      'enter',
    key:        'key1',
    key5_2:     'key5_2',
    key5_3:     'key5_3',
    standBy:    'stand by',
    complete:   'complete',
    release:    'release',
    error:      'error',
    ready:      'ready',
    exceed:     'exceed charge',
    weaponHit:  'weaponHit'     // 星号：武器打击
  };

  /* ========== 播放器：m4a → mp3 → wav → mp4（按支持度筛选 + 自动回退） ========== */
  let started=false, ringing=null;

  const mimeByExt = {
    m4a: 'audio/mp4',    // AAC in MP4 container
    mp3: 'audio/mpeg',
    wav: 'audio/wav',
    mp4: 'audio/mp4'
  };
  const extOrder = ['m4a','mp3','wav','mp4'];  // 优先顺序（iOS优先AAC/MP3）

  function buildCandidates(base){
    // 生成候选 URL，并按 canPlayType 过滤不支持的容器
    const testAudio = document.createElement('audio');
    const list = [];
    for(const ext of extOrder){
      const mime = mimeByExt[ext] || '';
      if (!mime || testAudio.canPlayType(mime) !== '') {
        // 空字符串=未知也允许尝试；'maybe'/'probably' 优先，但我们全部保留，后续 onerror 回退
        list.push(`assets/${base}.${ext}`);
      }
    }
    return list;
  }

  function play(name, {loop=false, delayMs=0}={}){
    const base = SND[name];
    if(!base){ beep(); return null; }

    const urls = buildCandidates(base);
    if (urls.length===0){ beep(); return null; }

    const a = new Audio();
    a.preload = 'auto';
    a.loop = !!loop;

    const tryUrl = (i) => {
      if(i >= urls.length){ beep(); return; }
      a.onerror = () => tryUrl(i+1);
      a.src = urls[i];
      const start = () => a.play().catch(()=>{ /* 等用户交互解锁后重试 */ });
      if(delayMs>0) setTimeout(start, delayMs); else start();
    };
    tryUrl(0);
    return a;
  }

  function beep(freq=520, ms=120, type='square', vol=0.22){
    try{
      const C = window.AudioContext||window.webkitAudioContext; if(!C) return;
      const ac = new C(); const o=ac.createOscillator(), g=ac.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g).connect(ac.destination); o.start();
      setTimeout(()=>{ try{o.stop();}catch{} }, ms);
    }catch{}
  }
  function stopRinging(){ if(ringing){ try{ringing.pause();}catch{} ringing=null; } }
  function anyKeyInterruptRing(){ stopRinging(); }

  function unlock(){ if(!started){ started=true; play('openPhone'); } }

  /* ========== 规则状态（与你之前一致 + 最近更新） ========== */
  const SPECIAL_STAGE = ['555','106','103']; // 三段按键音组合
  let buf='', transformed=false, armedStandby=false, armedReady=false;

  function pushKey(k){
    unlock();
    anyKeyInterruptRing();

    // 星号：武器打击
    if(k==='*'){ play('weaponHit'); buf=(buf+k).slice(-4); return; }

    // 5 的分段音，其它键统一 key
    if(k==='5'){
      const fiveCount=(buf.match(/5+$/)?.[0]?.length||0)+1;
      if(fiveCount===1) play('key');
      else if(fiveCount===2) play('key5_2');
      else play('key5_3');
    }else{
      play('key');
    }
    buf=(buf+k).slice(-4);
  }

  function onEnter(){
    unlock();
    anyKeyInterruptRing();

    const last3 = buf.slice(-3);

    // 变身态 + 106/103：只触发 enter
    if(transformed && (last3==='106' || last3==='103')){
      play('enter');
      return;
    }

    // 555 -> stand by 流程：本次完成（不播 enter）
    if(armedStandby){
      armedStandby=false; play('complete'); transformed=true; armedReady=false; return;
    }

    if(transformed){
      // 第一次 ENTER：ready（无 enter）
      if(!armedReady){ play('ready'); armedReady=true; return; }
      // 第二次 ENTER：enter + exceed
      play('enter'); play('exceed', {delayMs:120}); armedReady=false; return;
    }

    // 未变身态
    if(last3==='555'){
      play('enter'); play('standBy'); armedStandby=true; return;
    }
    if(last3==='106' || last3==='103'){
      play('enter'); return;
    }

    // 非 {555,106,103,3821} 的三位组合：enter 后 error 并重置
    if(buf.length===3 && last3!=='3821'){
      play('enter'); play('error', {delayMs:40});
      buf=''; armedStandby=false; armedReady=false; return;
    }

    // 3821：默认 enter（如需独立音效可扩展）
    play('enter');
  }

  function onRingStart(){ unlock(); stopRinging(); ringing=play('ringStart', {loop:true}); }
  function onRingStop(){ unlock(); play('key'); stopRinging(); }
  function onClear(){
    unlock(); anyKeyInterruptRing();
    // クリア：按键声后释放，并退出变身态
    play('key'); play('release', {delayMs:40});
    transformed=false; armedStandby=false; armedReady=false; buf='';
  }

  // 绑定
  document.getElementById('btnEnter').addEventListener('click', onEnter);
  document.getElementById('btnRing').addEventListener('click', onRingStart);
  document.getElementById('btnStop').addEventListener('click', onRingStop);
  document.getElementById('btnClear').addEventListener('click', onClear);
  ['k1','k2','k3','k4','k5','k6','k7','k8','k9','kStar','k0','kHash'].forEach(id=>{
    const el=document.getElementById(id); el.addEventListener('click', ()=>pushKey(el.dataset.k));
  });

  // 首次手势尽快“解锁”音频
  ['pointerdown','touchstart','click','keydown'].forEach(ev=>{
    window.addEventListener(ev, ()=>{ try{unlock();}catch{} }, {once:true, passive:true});
  });
})();
</script>
</body>
</html>
