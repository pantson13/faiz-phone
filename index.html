<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>FAIZ Phone â€“ 15é”®æµ‹è¯•(çº¯HTML)</title>
<style>
  :root{--bg:#0b0f19;--bg-red:#7f1d1d;--fg:#fff;--panel:#0f172a;--border:#334155;--muted:#94a3b8}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg); color:var(--fg);
    -webkit-text-size-adjust:100%;
    touch-action:manipulation; /* ç¦åŒå‡»ç¼©æ”¾ */
    -webkit-user-select:none; user-select:none;
  }
  .wrap{max-width:480px;margin:0 auto;padding:16px;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .card{width:100%}
  h1{margin:0 0 8px;font-size:18px;text-align:center}
  .display{display:flex;align-items:center;justify-content:space-between;background:#0f172acc;border:1px solid var(--border);border-radius:12px;height:48px;padding:0 12px;margin-bottom:8px}
  .digits{font-weight:700;letter-spacing:.3em}
  .hint{font-size:12px;color:var(--muted)}
  .panel{background:#0f172a99;border:1px solid var(--border);border-radius:16px;padding:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
  .keys{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button.key{
    width:100%;height:56px;border-radius:14px;border:1px solid var(--border);
    background:#0f172acc;color:#fff;font-weight:700;font-size:18px;touch-action:manipulation;
  }
  button.key:active{transform:scale(.98)}
  .status{font-size:12px;color:var(--muted);margin:6px 0 10px}
  .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f0f15;color:#fff;touch-action:manipulation}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
  .modal>.box{width:min(92vw,720px);max-height:86vh;overflow:auto;background:#0b0f1a;border:1px solid var(--border);border-radius:16px;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .muted{font-size:12px;color:var(--muted)}
  .drop{border:1px dashed var(--border);border-radius:12px;padding:16px;text-align:center;color:var(--muted);margin-bottom:12px}
  .pair{border:1px solid var(--border);border-radius:12px;padding:10px}
  .tag{font-size:12px;color:var(--muted)}
  .ok{color:#22c55e}.warn{color:#fbbf24}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <div class="card">
    <h1>FAIZ Phone â€“ 15 é”®æµ‹è¯•ï¼ˆçº¯HTMLï¼‰</h1>

    <div class="display">
      <div class="digits" id="digits">â€”â€”â€”</div>
      <div class="hint" id="hint">ç‚¹ä»»æ„é”®è§£é”éŸ³é¢‘</div>
    </div>

    <div class="panel" id="panel">
      <!-- ç¬¬ä¸€è¡Œï¼šENTER å•ç‹¬ä¸€è¡Œï¼ˆä¸é“ƒå£°æŒ‰é’®å¯¹é½å®½åº¦ï¼‰ -->
      <div class="grid3">
        <button class="key" id="btnEnter">ENTER</button>
        <div></div>
        <div></div>

        <!-- ç¬¬äºŒè¡Œï¼šå·¦-é“ƒå£° ä¸­-å¾…å®š å³-åœæ­¢ï¼ˆä¸ ENTER åŒè¡Œå¯¹é½ï¼‰ -->
        <button class="key" id="btnRing">â˜ï¸ é“ƒå£°</button>
        <button class="key" id="btnUnset">å¾…å®š</button>
        <button class="key" id="btnStop">â›”ï¸ åœæ­¢</button>
      </div>

      <div class="status" id="status">å¾…æœº</div>

      <!-- æ•°å­—é”®ç›˜ 3Ã—4 -->
      <div class="keys" id="keys"></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnBrowser">ğŸ“‚ æµè§ˆ/ç®¡ç†éŸ³æ•ˆ</button>
      <button class="btn" id="btnExport">å¯¼å‡º JSON</button>
      <button class="btn" id="btnClear">æ¸…ç©º</button>
    </div>
  </div>
</div>

<!-- éŸ³æ•ˆæµè§ˆç®¡ç†ï¼ˆä¿ç•™ï¼Œå¯éšæ—¶æ‰‹åŠ¨è¦†ç›–é»˜è®¤æ˜ å°„ï¼‰ -->
<div class="modal" id="modal">
  <div class="box">
    <div class="row"><div>æµè§ˆå’Œç®¡ç†éŸ³æ•ˆ</div><div style="flex:1"></div><button class="btn" id="btnClose">å…³é—­</button></div>
    <div class="row">
      <label class="btn">æ‰¹é‡é€‰æ‹©æ–‡ä»¶<input type="file" id="fileMulti" class="hidden" style="display:none" multiple accept="audio/*" /></label>
      <div class="muted">æŒ‰æ–‡ä»¶åè‡ªåŠ¨åŒ¹é…ï¼šopen phone / ring / enter / key1 / key5_2 / key5_3 / stand by / complete / 103 / 106 / 3821</div>
    </div>
    <div class="drop" id="drop">å°†éŸ³é¢‘æ–‡ä»¶æ‹–åˆ°è¿™é‡Œï¼Œè‡ªåŠ¨åŒ¹é…å¹¶ä¿å­˜</div>
    <div id="pairs" class="grid3" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"></div>
  </div>
</div>

<script>
(function(){
  const digitsEl = document.getElementById('digits');
  const hintEl   = document.getElementById('hint');
  const statusEl = document.getElementById('status');
  const wrapEl   = document.getElementById('wrap');
  const keysEl   = document.getElementById('keys');

  // è¯»å–é…ç½®
  const cfg = (()=>{ try{ return JSON.parse(localStorage.getItem('faiz_cfg_v1')||'{}'); }catch{ return {}; } })();
  const saveCfg = ()=>{ try{ localStorage.setItem('faiz_cfg_v1', JSON.stringify(cfg)); }catch(e){} };

  // â€”â€” é»˜è®¤éŸ³æ•ˆï¼šé¦–è®¿è‡ªåŠ¨æŒ‡å‘ /assetsï¼›è‹¥ç”¨æˆ·åæ¥åœ¨ç®¡ç†å™¨é‡Œæ”¹äº†ï¼Œå°†ä¿ç•™ç”¨æˆ·ç‰ˆ
  const defaults = {
    openPhone:  '/assets/open phone.m4a',
    ring:       '/assets/ring.m4a',
    enter:      '/assets/enter.m4a',
    key1:       '/assets/key1.m4a',
    key5_2:     '/assets/key5_2.m4a',
    key5_3:     '/assets/key5_3.m4a',
    standBy:    '/assets/stand by.m4a',
    complete:   '/assets/complete.m4a',
    combo103:   '/assets/103.m4a',
    combo106:   '/assets/106.m4a',
    combo3821:  '/assets/3821.m4a'
  };
  for (const k in defaults) if (!cfg[k]) cfg[k] = defaults[k];
  saveCfg();

  // éŸ³é¢‘ä¸Šä¸‹æ–‡ & åŸºæœ¬å“”å£°
  let started=false, ac=null;
  let fiveCount=0, buf='', armedStand=false, transformed=false;
  let ringNode=null, standNode=null;

  function ensureAC(){
    if (ac) return ac;
    const C = window.AudioContext||window.webkitAudioContext;
    if (!C) return null;
    ac = new C();
    return ac;
  }
  function beep(opt){
    const ctx=ensureAC(); if(!ctx) return;
    const o=opt||{}, osc=ctx.createOscillator(), g=ctx.createGain();
    osc.type=o.type||'square'; osc.frequency.value=o.freq||520; g.gain.value=(o.vol==null?0.22:o.vol);
    osc.connect(g).connect(ctx.destination); osc.start();
    setTimeout(()=>{ try{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05);}catch{} try{osc.stop();}catch{} }, o.ms||140);
  }
  function playKey(name, loop){
    const url=cfg[name];
    if(!url){
      // å…œåº•å“”å£°
      if(name==='enter')     return beep({freq:560,ms:160,type:'sawtooth',vol:0.26});
      if(name==='complete')  return beep({freq:260,ms:360,type:'square',vol:0.30});
      if(name==='standBy')   return beep({freq:720,ms:260,type:'triangle',vol:0.28});
      return beep({freq:520,ms:120,type:'square',vol:0.24});
    }
    try{ const a=new Audio(url); a.loop=!!loop; a.play().catch(()=>{}); return a; }catch{ return; }
  }
  function safePause(node){ if (node && typeof node.pause==='function') { try{ node.pause(); }catch{} } }

  function showDigits(s){ const t=(s||'').padStart(3,'â€”').slice(-3); digitsEl.textContent=t; }
  function setStatus(t){ statusEl.textContent=t; }

  // é¦–æ¬¡è§¦æ‘¸è§£é” + è‡ªåŠ¨æ’­å¼€æœºéŸ³
  function unlock(){
    if (started) return;
    started=true; ensureAC();
    hintEl.textContent='å·²è§£é”';
    playKey('openPhone'); // å¼€æœºéŸ³
  }

  // è¾“å…¥é€»è¾‘
  function push(k){
    unlock();
    if(k==='*'||k==='#'){ playKey('key1'); return; }

    if(k==='5'){
      fiveCount=(fiveCount%3)+1;
      if     (fiveCount===1) playKey('key1');
      else if(fiveCount===2) playKey('key5_2');
      else                   playKey('key5_3');
    }else{
      fiveCount=0; playKey('key1');
    }

    buf=(buf+k).slice(-4); showDigits(buf);

    if(buf.endsWith('103'))  { setStatus('ç‰¹æ®Šï¼š103');  playKey('combo103'); }
    if(buf.endsWith('106'))  { setStatus('ç‰¹æ®Šï¼š106');  playKey('combo106'); }
    if(buf.endsWith('3821')) { setStatus('ç‰¹æ®Šï¼š3821'); playKey('combo3821'); }
    if(buf.endsWith('555'))  { setStatus('å·²è¾“å…¥ 555'); }
  }

  // ENTER è§„åˆ™
  function onEnter(){
    unlock();

    // å·²ç»æ­¦è£…ï¼šç¬¬äºŒæ¬¡ ENTER -> åªæ’­ completeï¼Œå˜çº¢å¹¶æ¸…ç©º
    if (armedStand){
      safePause(standNode); standNode=null;
      const a=playKey('complete');
      const after=()=>{ transformed=true; wrapEl.style.background='var(--bg-red)'; buf=''; showDigits(''); setStatus('å®Œæˆ'); };
      if(a){ try{ a.onended=after; }catch{ setTimeout(after,380); } } else { setTimeout(after,380); }
      armedStand=false;
      return;
    }

    // ç¬¬ä¸€æ¬¡ ENTERï¼šæ€»æ˜¯å…ˆæ’­ enter
    playKey('enter');

    // è‹¥æœ«å°¾æ˜¯ 555ï¼šæ¥ç€æ’­ stand byï¼ˆä¸å¾ªç¯ï¼‰ï¼Œå¹¶æ­¦è£…
    if (buf.endsWith('555')){
      safePause(standNode); standNode=null;
      const n=playKey('standBy', false);
      if(n){ try{ n.onended=()=>{ standNode=null; }; }catch{} standNode=n; }
      armedStand=true; setStatus('Stand by');
    }else{
      setStatus('ENTER');
    }
  }

  // é“ƒå£°
  function ringStart(){
    unlock();
    safePause(ringNode); ringNode=null;
    const url=cfg['ring'];
    if(url){ const a=new Audio(url); a.loop=true; a.play().catch(()=>{}); ringNode=a; }
    else{
      const id=setInterval(()=>{ beep({freq:660,ms:150,vol:0.18}); setTimeout(()=>beep({freq:550,ms:150,vol:0.18}),170); },320);
      ringNode={ pause:()=>clearInterval(id) };
    }
    setStatus('å“é“ƒä¸­');
  }
  function ringStop(){ safePause(ringNode); ringNode=null; setStatus('é“ƒå£°åœæ­¢'); }

  // å¾…å®šï¼šè§£é™¤å˜èº«ï¼ˆç”¨æ™®é€šæŒ‰é”®éŸ³ï¼‰
  function onUnset(){ playKey('key1'); transformed=false; wrapEl.style.background='var(--bg)'; setStatus('è§£é™¤å˜èº«'); }

  // æ„å»ºé”®ç›˜
  const grid=['1','2','3','4','5','6','7','8','9','*','0','#'];
  grid.forEach(k=>{
    const b=document.createElement('button'); b.className='key'; b.textContent=k;
    b.onclick=()=>push(k);
    keysEl.appendChild(b);
  });

  // ç»‘å®šæŒ‰é’®
  document.getElementById('btnEnter').onclick=onEnter;
  document.getElementById('btnRing').onclick=ringStart;
  document.getElementById('btnStop').onclick=ringStop;
  document.getElementById('btnUnset').onclick=onUnset;

  // å¯¼å‡º/æ¸…ç©º
  const modal=document.getElementById('modal');
  document.getElementById('btnBrowser').onclick=()=>{ modal.style.display='flex'; };
  document.getElementById('btnClose').onclick=()=>{ modal.style.display='none'; };
  document.getElementById('btnExport').onclick=()=>{ const s=JSON.stringify(cfg); navigator.clipboard&&navigator.clipboard.writeText(s); setStatus('å·²å¤åˆ¶ JSON'); };
  document.getElementById('btnClear').onclick=()=>{ buf=''; showDigits(''); armedStand=false; setStatus('å·²æ¸…ç©º'); };

  // ç®¡ç†å™¨ï¼ˆå¯æ‰‹åŠ¨è¦†ç›–ï¼‰
  const keyList=[
    ['openPhone','Open phone'],
    ['ring','é“ƒå£°'],
    ['enter','ENTER'],
    ['key1','æ™®é€šæŒ‰é”®'],
    ['key5_2','5(ç¬¬äºŒæ¬¡)'],
    ['key5_3','5(ç¬¬ä¸‰æ¬¡)'],
    ['standBy','Stand by'],
    ['complete','Complete'],
    ['combo103','103'],
    ['combo106','106'],
    ['combo3821','3821']
  ];
  const nameMap={
    'openphone':'openPhone','open phone':'openPhone',
    'ring':'ring',
    'enter':'enter',
    'key1':'key1',
    'key5_2':'key5_2','key5-2':'key5_2',
    'key5_3':'key5_3','key5-3':'key5_3',
    'standby':'standBy','stand by':'standBy',
    'complete':'complete',
    'combo103':'combo103','103':'combo103',
    'combo106':'combo106','106':'combo106',
    'combo3821':'combo3821','3821':'combo3821'
  };
  function baseNoExt(n){ const i=n.lastIndexOf('.'); return (i>=0?n.slice(0,i):n).toLowerCase().replace(/\s+/g,' '); }
  function autoMapList(files){
    let matched=0;
    [...files].forEach(f=>{
      const r=new FileReader();
      r.onload=()=>{ const key=nameMap[ baseNoExt(f.name) ]; if(key){ cfg[key]=r.result; matched++; saveCfg(); refreshPairs(); } };
      r.readAsDataURL(f);
    });
    setStatus('å·²é€‰æ‹© '+files.length+' ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨åŒ¹é… '+matched+' ä¸ª');
  }
  const pairsEl=document.getElementById('pairs');
  function refreshPairs(){
    pairsEl.innerHTML='';
    keyList.forEach(([key,label])=>{
      const d=document.createElement('div');
      d.className='pair';
      d.innerHTML = `<div style="font-weight:600">${label} <span class="tag">(${key})</span></div>
        <div class="tag">${cfg[key]?'<span class="ok">âœ… å·²é…ç½®</span>':'<span class="warn">âš ï¸ æœªé…ç½®</span>'}</div>
        <div class="row">
          <label class="btn">é€‰æ‹©æ–‡ä»¶<input type="file" style="display:none" accept="audio/*" /></label>
          <button class="btn" data-act="preview">è¯•å¬</button>
          <button class="btn" data-act="clear">æ¸…é™¤</button>
          ${cfg[key]?`<audio controls src="${cfg[key]}" preload="none" style="width:100%;margin-top:6px"></audio>`:''}
        </div>`;
      const input=d.querySelector('input[type=file]');
      input.onchange=(e)=>{
        const f=e.target.files && e.target.files[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{ cfg[key]=r.result; saveCfg(); refreshPairs(); }; r.readAsDataURL(f);
      };
      d.querySelector('[data-act=preview]').onclick=()=>{
        const u=cfg[key]; if(!u){ setStatus('æœªé…ç½®ï¼š'+key); beep(); return; }
        try{ const a=new Audio(u); a.play().catch(()=>{});}catch{}
      };
      d.querySelector('[data-act=clear]').onclick=()=>{ delete cfg[key]; saveCfg(); refreshPairs(); };
      pairsEl.appendChild(d);
    });
  }
  refreshPairs();

  // æ‹–æ‹½/æ‰¹é‡
  const drop=document.getElementById('drop');
  drop.ondragover=(e)=>{ e.preventDefault(); };
  drop.ondrop=(e)=>{ e.preventDefault(); if(e.dataTransfer && e.dataTransfer.files){ autoMapList(e.dataTransfer.files); } };
  document.getElementById('fileMulti').onchange=(e)=>{ const fs=e.target.files; if(fs && fs.length) autoMapList(fs); e.target.value=''; };
  drop.previousElementSibling.querySelector('label.btn').onclick=function(){ document.getElementById('fileMulti').click(); };

  // ä¿é™©ï¼šæ‹¦æˆªæ‰‹åŠ¿ç¼©æ”¾ï¼ˆiOS æŸäº›ç‰ˆæœ¬ï¼‰
  ['gesturestart','gesturechange','gestureend'].forEach(ev=>{
    document.addEventListener(ev, e=>{ e.preventDefault(); }, {passive:false});
  });
})();
</script>
</body>
</html>
